# Taint Analysis Module

> æ±¡ç‚¹åˆ†ææ ¸å¿ƒæ¨¡å— - ç”¨äºè¿½è¸ªç”¨æˆ·å¯æ§æ•°æ®ä»è¾“å…¥åˆ°å±é™©å‡½æ•°çš„å®Œæ•´è·¯å¾„

## ä¸“é¡¹è¯¦ç»†è§„åˆ™

| æ¼æ´ç±»å‹ | è¯¦ç»†è§„åˆ™æ–‡ä»¶ | Sink ç¤ºä¾‹ |
|----------|--------------|-----------|
| ååºåˆ—åŒ– Gadget | `languages/java_gadget_chains.md` | readObject, parseObject |
| JNDI æ³¨å…¥ | `languages/java_jndi_injection.md` | InitialContext.lookup |
| XXE | `languages/java_xxe.md` | DocumentBuilder.parse |
| Fastjson | `languages/java_fastjson.md` | JSON.parseObject |
| é€šç”¨ Sink/Source | `core/sinks_sources.md` | å®Œæ•´è§„åˆ™åº“ |

## Overview

æ±¡ç‚¹åˆ†ææ˜¯ä»£ç å®¡è®¡çš„æ ¸å¿ƒæ–¹æ³•è®ºï¼Œé€šè¿‡è¿½è¸ªä¸å¯ä¿¡æ•°æ®(æ±¡ç‚¹)ä»è¿›å…¥ç³»ç»Ÿåˆ°è§¦å‘å±é™©æ“ä½œçš„å®Œæ•´æµç¨‹ï¼Œç²¾ç¡®å®šä½å®‰å…¨æ¼æ´ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Taint Analysis Flow                        â”‚
â”‚                                                                 â”‚
â”‚   Source â”€â”€â†’ Propagation â”€â”€â†’ Sanitizer? â”€â”€â†’ Sink               â”‚
â”‚   (æ±¡ç‚¹æº)    (ä¼ æ’­è·¯å¾„)      (å‡€åŒ–æ£€æŸ¥)     (æ±‡èšç‚¹)            â”‚
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·è¾“å…¥    å˜é‡èµ‹å€¼         è¿‡æ»¤/è½¬ä¹‰      å±é™©å‡½æ•°            â”‚
â”‚              å‡½æ•°å‚æ•°          éªŒè¯/ç¼–ç       æ‰§è¡Œæ“ä½œ            â”‚
â”‚              è¿”å›å€¼            ç™½åå•                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Taint Analysis Report Template

### æ ‡å‡†æŠ¥å‘Šæ ¼å¼

```markdown
## [ä¸¥é‡ç¨‹åº¦] æ¼æ´ç±»å‹ - æ–‡ä»¶å:è¡Œå·

### åŸºæœ¬ä¿¡æ¯
| å±æ€§ | å€¼ |
|------|-----|
| æ¼æ´ç±»å‹ | SQLæ³¨å…¥ / XSS / RCE / SSRF / ... |
| ä¸¥é‡ç¨‹åº¦ | Critical / High / Medium / Low |
| CWEç¼–å· | CWE-89 / CWE-79 / CWE-78 / ... |
| æ–‡ä»¶ä½ç½® | path/to/file.ext:è¡Œå· |
| å‡½æ•°åç§° | function_name() |

---

### Source (æ±¡ç‚¹æº)

**ä½ç½®**: `file.ext:è¡Œå·`

**ç±»å‹**: [HTTPå‚æ•° / Cookie / Header / æ–‡ä»¶è¯»å– / æ•°æ®åº“ / ç¯å¢ƒå˜é‡]

**ä»£ç **:
\`\`\`language
// æ±¡ç‚¹å¼•å…¥ç‚¹ä»£ç 
\`\`\`

**è¯´æ˜**: æè¿°ä¸ºä»€ä¹ˆæ­¤å¤„æ˜¯æ±¡ç‚¹æºï¼Œæ•°æ®å¦‚ä½•è¿›å…¥ç³»ç»Ÿ

---

### Taint Propagation (æ±¡ç‚¹ä¼ æ’­è·¯å¾„)

\`\`\`
[æ­¥éª¤1] file.ext:è¡Œå·
        ä»£ç : variable = source_input
        æ“ä½œ: æ±¡ç‚¹å¼•å…¥
        â†“
[æ­¥éª¤2] file.ext:è¡Œå·
        ä»£ç : processed = transform(variable)
        æ“ä½œ: æ±¡ç‚¹ä¼ é€’ (æœªå‡€åŒ–)
        â†“
[æ­¥éª¤3] file.ext:è¡Œå·
        ä»£ç : result = build_query(processed)
        æ“ä½œ: æ±¡ç‚¹æ‹¼æ¥
        â†“
[æ­¥éª¤4] file.ext:è¡Œå·
        ä»£ç : execute(result)
        æ“ä½œ: æ±¡ç‚¹åˆ°è¾¾Sink
\`\`\`

**ä¼ æ’­é“¾æ‘˜è¦**:
- æ€»è·¨åº¦: X è¡Œä»£ç  / X ä¸ªå‡½æ•° / X ä¸ªæ–‡ä»¶
- ä¸­é—´å˜é‡: var1 â†’ var2 â†’ var3 â†’ sinkå‚æ•°
- è·¨å‡½æ•°è°ƒç”¨: funcA() â†’ funcB() â†’ funcC()

---

### Sink (æ±‡èšç‚¹)

**ä½ç½®**: `file.ext:è¡Œå·`

**ç±»å‹**: [SQLæ‰§è¡Œ / å‘½ä»¤æ‰§è¡Œ / æ–‡ä»¶æ“ä½œ / ç½‘ç»œè¯·æ±‚ / æ¨¡æ¿æ¸²æŸ“ / ååºåˆ—åŒ–]

**ä»£ç **:
\`\`\`language
// å±é™©æ“ä½œä»£ç 
\`\`\`

**å±å®³**:
- æ”»å‡»è€…å¯å®ç°: [å…·ä½“å±å®³æè¿°]
- å½±å“èŒƒå›´: [æ•°æ®æ³„éœ²/æœåŠ¡å™¨æ§åˆ¶/ç”¨æˆ·å½±å“]

---

### Taint Analysis (æ±¡ç‚¹åˆ†æç»“è®º)

| åˆ†æé¡¹ | ç»“æœ |
|--------|------|
| æ±¡ç‚¹æºå¯æ§æ€§ | å®Œå…¨å¯æ§ / éƒ¨åˆ†å¯æ§ / éœ€ç‰¹å®šæ¡ä»¶ |
| å­˜åœ¨å‡€åŒ–æªæ–½ | æ—  / æœ‰ä½†å¯ç»•è¿‡ / æœ‰æ•ˆå‡€åŒ– |
| ç»•è¿‡å¯èƒ½æ€§ | é«˜ / ä¸­ / ä½ |
| åˆ©ç”¨å¤æ‚åº¦ | ç®€å• / ä¸­ç­‰ / å¤æ‚ |
| éœ€è¦è®¤è¯ | æ˜¯ / å¦ |

**å‡€åŒ–æ£€æŸ¥**:
- [ ] è¾“å…¥éªŒè¯: æ—  / ç™½åå• / é»‘åå• / æ­£åˆ™
- [ ] ç¼–ç è½¬ä¹‰: æ—  / HTMLå®ä½“ / URLç¼–ç  / SQLå‚æ•°åŒ–
- [ ] ç±»å‹è½¬æ¢: æ—  / å¼ºåˆ¶ç±»å‹ / é•¿åº¦é™åˆ¶

**æ”»å‡»å‘é‡**:
\`\`\`
ç¤ºä¾‹payloadæˆ–æ”»å‡»è·¯å¾„
\`\`\`

---

### PoC (æ¦‚å¿µéªŒè¯)

**å‰ç½®æ¡ä»¶**: æè¿°åˆ©ç”¨éœ€è¦çš„æ¡ä»¶

**åˆ©ç”¨æ­¥éª¤**:
1. æ­¥éª¤ä¸€
2. æ­¥éª¤äºŒ
3. æ­¥éª¤ä¸‰

**Payload**:
\`\`\`
å…·ä½“çš„æ”»å‡»payload
\`\`\`

**é¢„æœŸç»“æœ**: æè¿°æ”»å‡»æˆåŠŸåçš„ç°è±¡

---

### ä¿®å¤å»ºè®®

**æ¨èæ–¹æ¡ˆ**:
\`\`\`language
// å®‰å…¨ä»£ç ç¤ºä¾‹
\`\`\`

**æ›¿ä»£æ–¹æ¡ˆ**: å…¶ä»–å¯è¡Œçš„ä¿®å¤æ–¹å¼

**ä¿®å¤åŸåˆ™**:
1. åŸåˆ™ä¸€
2. åŸåˆ™äºŒ

---

### å‚è€ƒèµ„æ–™
- CWE: https://cwe.mitre.org/data/definitions/XXX.html
- OWASP: ç›¸å…³é“¾æ¥
```

---

## Tracking Strategy (è¿½è¸ªç­–ç•¥)

### å‡½æ•°çº§ vs å˜é‡çº§è¿½è¸ª

> å‚è€ƒ: JavaSinkTracer çš„è®¾è®¡ç†å¿µ

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **å˜é‡çº§è¿½è¸ª** | ç²¾ç¡®ã€èƒ½è¯†åˆ«å‡€åŒ–ç‚¹ | æ˜“æ–­é“¾(åå°„/çº¿ç¨‹/å›è°ƒ) | ç®€å•æ•°æ®æµ |
| **å‡½æ•°çº§è¿½è¸ª** | ç¨³å®šã€ä¸æ˜“æ–­é“¾ | å¯èƒ½æœ‰è¯¯æŠ¥ | å¤æ‚è°ƒç”¨å…³ç³» |

**æ¨èç­–ç•¥**: å…ˆç”¨å‡½æ•°çº§è¿½è¸ªå»ºç«‹è°ƒç”¨é“¾ï¼Œå†ç”¨å˜é‡çº§éªŒè¯æ±¡ç‚¹ä¼ æ’­

### BFSåå‘è¿½æº¯ç®—æ³•

```
ç®—æ³•: Sinkåˆ°Sourceçš„å¹¿åº¦ä¼˜å…ˆæœç´¢

è¾“å…¥: sink_method, call_graph, max_depth
è¾“å‡º: æ‰€æœ‰åˆ°è¾¾Sourceçš„è°ƒç”¨é“¾

procedure TRACE_BACK(sink_method):
    queue = [(sink_method, [sink_method], 0)]  // (å½“å‰æ–¹æ³•, è·¯å¾„, æ·±åº¦)
    visited = set()
    results = []

    while queue not empty:
        current, path, depth = queue.pop(0)

        if current in visited or depth > max_depth:
            continue
        visited.add(current)

        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾Source (å¤–éƒ¨å…¥å£ç‚¹)
        if is_source_method(current):
            results.append(path)
            continue

        // è·å–æ‰€æœ‰è°ƒç”¨å½“å‰æ–¹æ³•çš„caller
        for caller in get_callers(current, call_graph):
            // è¿‡æ»¤æ— å‚æ–¹æ³• (æ— æ³•æ¥æ”¶æ±¡ç‚¹)
            if not has_parameters(caller):
                continue
            queue.append((caller, path + [caller], depth + 1))

    return results
```

---

## LSP-Enhanced Tracking (LSPå¢å¼ºè¿½è¸ª)

> v2.4.0 æ–°å¢ - åˆ©ç”¨è¯­è¨€æœåŠ¡åè®®å®ç°ç²¾ç¡®çš„ä»£ç è·³è½¬å’Œå¼•ç”¨åˆ†æ

### ä¸ºä»€ä¹ˆä½¿ç”¨ LSP è€Œä¸æ˜¯ Grepï¼Ÿ

| æ–¹æ³• | æœç´¢ `sanitize` | ç»“æœ |
|------|-----------------|------|
| **Grep** | `grep "sanitize"` | åŒ¹é…å­—ç¬¦ä¸²ã€æ³¨é‡Šã€å˜é‡å (å™ªéŸ³å¤§) |
| **LSP** | `findReferences(sanitize)` | **ä»…è¿”å›å®é™…ä»£ç å¼•ç”¨** (ç²¾ç¡®) |

**æ ¸å¿ƒä¼˜åŠ¿**:
- **è¯­ä¹‰çº§åˆ†æ**: åŒºåˆ†å‡½æ•°è°ƒç”¨ vs å­—ç¬¦ä¸²åŒ¹é…
- **è·¨æ–‡ä»¶è¿½è¸ª**: è‡ªåŠ¨è§£æ import/include å…³ç³»
- **å¤šæ€æ„ŸçŸ¥**: æ‰¾åˆ°æ¥å£çš„æ‰€æœ‰å®ç°ç±»
- **è°ƒç”¨é“¾åˆ†æ**: è·å–å®Œæ•´çš„è°ƒç”¨è€…/è¢«è°ƒç”¨è€…å…³ç³»

### LSP æ“ä½œä¸å®¡è®¡åœºæ™¯æ˜ å°„

| LSP æ“ä½œ | å®¡è®¡åœºæ™¯ | ä½¿ç”¨ç¤ºä¾‹ |
|----------|----------|----------|
| `goToDefinition` | **æ±¡ç‚¹æº¯æº** | è¿½è¸ªå˜é‡æ¥è‡ªå“ªé‡Œ |
| `findReferences` | **å½±å“é¢åˆ†æ** | å±é™©å‡½æ•°è¢«å“ªäº›åœ°æ–¹è°ƒç”¨ |
| `goToImplementation` | **å¤šæ€ç©¿é€** | æ¥å£èƒŒåçš„å®é™…å®ç° |
| `incomingCalls` | **æ”»å‡»é¢æ˜ å°„** | è°è°ƒç”¨äº† `executeQuery()` |
| `outgoingCalls` | **æ±¡ç‚¹ä¼ æ’­** | è¯¥å‡½æ•°åˆè°ƒç”¨äº†ä»€ä¹ˆ |
| `documentSymbol` | **å…¥å£ç‚¹æšä¸¾** | Controller çš„æ‰€æœ‰æ–¹æ³• |
| `workspaceSymbol` | **å…¨å±€æœç´¢** | æ‰¾æ‰€æœ‰ `*Handler` ç±» |

### å®æˆ˜å·¥ä½œæµï¼šè¿½è¸ª SQL æ³¨å…¥

```
åœºæ™¯: å‘ç° executeQuery(sql) è°ƒç”¨ï¼Œè¿½è¸ª sql å˜é‡æ¥æº

Step 1: å®šä½ Sink
â””â”€ ä½¿ç”¨ Grep æ‰¾åˆ°: UserDao.java:45 - stmt.executeQuery(sql)

Step 2: LSP å˜é‡æº¯æº
â””â”€ LSP goToDefinition(sql) â†’ è·³è½¬åˆ° sql å˜é‡å®šä¹‰
   â””â”€ å‘ç°: sql = buildQuery(userId) at line 42

Step 3: LSP å‡½æ•°è¿½è¸ª
â””â”€ LSP goToDefinition(buildQuery) â†’ è·³è½¬åˆ°å‡½æ•°å®šä¹‰
   â””â”€ å‘ç°: buildQuery() åœ¨ QueryHelper.java:20

Step 4: LSP è°ƒç”¨é“¾åˆ†æ
â””â”€ LSP incomingCalls(executeQuery) â†’ æ‰¾åˆ°æ‰€æœ‰è°ƒç”¨è€…
   â””â”€ å‘ç° 5 ä¸ªè°ƒç”¨ç‚¹ï¼Œ2 ä¸ªæ¥è‡ª Controller å±‚ (HTTPå…¥å£)

Step 5: ç¡®è®¤æ”»å‡»è·¯å¾„
â””â”€ Controller â†’ Service â†’ DAO â†’ executeQuery()
â””â”€ userId æ¥è‡ª @RequestParam â†’ ç¡®è®¤ä¸º Source
```

### LSP å‘½ä»¤å‚è€ƒ

```python
# æ±¡ç‚¹æº¯æº - è¿½è¸ªå˜é‡å®šä¹‰
LSP goToDefinition(filePath, line, character)
# è¿”å›: å˜é‡/å‡½æ•°çš„å®šä¹‰ä½ç½®

# å½±å“é¢åˆ†æ - è°ä½¿ç”¨äº†è¿™ä¸ªç¬¦å·
LSP findReferences(filePath, line, character)
# è¿”å›: æ‰€æœ‰å¼•ç”¨ä½ç½®åˆ—è¡¨

# å¤šæ€åˆ†æ - æ¥å£çš„å®ç°
LSP goToImplementation(filePath, line, character)
# è¿”å›: æ¥å£/æŠ½è±¡æ–¹æ³•çš„æ‰€æœ‰å®ç°

# è°ƒç”¨é“¾ - è°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°
LSP incomingCalls(filePath, line, character)
# è¿”å›: æ‰€æœ‰è°ƒç”¨å½“å‰å‡½æ•°çš„ä½ç½®

# æ±¡ç‚¹ä¼ æ’­ - è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†ä»€ä¹ˆ
LSP outgoingCalls(filePath, line, character)
# è¿”å›: å½“å‰å‡½æ•°è°ƒç”¨çš„æ‰€æœ‰å‡½æ•°

# å…¥å£ç‚¹æšä¸¾ - åˆ—å‡ºæ–‡ä»¶ä¸­çš„æ‰€æœ‰ç¬¦å·
LSP documentSymbol(filePath, line, character)
# è¿”å›: ç±»ã€æ–¹æ³•ã€å˜é‡ç­‰ç¬¦å·åˆ—è¡¨

# å…¨å±€æœç´¢ - æŒ‰åç§°æœç´¢ç¬¦å·
LSP workspaceSymbol(filePath, line, character)
# è¿”å›: å·¥ä½œåŒºå†…åŒ¹é…çš„ç¬¦å·
```

### å¸¸è§å®¡è®¡æ¨¡å¼

#### æ¨¡å¼ 1: å±é™©å‡½æ•°è°ƒç”¨ç‚¹æšä¸¾

```
ç›®æ ‡: æ‰¾åˆ°æ‰€æœ‰ Runtime.exec() è°ƒç”¨

1. Grep å¿«é€Ÿå®šä½ä¸€ä¸ªè°ƒç”¨ç‚¹
2. LSP goToDefinition è·³è½¬åˆ° exec() å®šä¹‰
3. LSP findReferences è·å–æ‰€æœ‰è°ƒç”¨ç‚¹
4. å¯¹æ¯ä¸ªè°ƒç”¨ç‚¹è¿›è¡Œæ±¡ç‚¹åˆ†æ
```

#### æ¨¡å¼ 2: æ•°æ®éªŒè¯å‡½æ•°æœ‰æ•ˆæ€§

```
ç›®æ ‡: éªŒè¯ sanitize() æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨

1. LSP findReferences(sanitize) æ‰¾åˆ°æ‰€æœ‰è°ƒç”¨ç‚¹
2. å¯¹æ¯” LSP findReferences(dangerousSink) çš„è°ƒç”¨ç‚¹
3. æ£€æŸ¥æ˜¯å¦æ¯ä¸ª Sink è°ƒç”¨å‰éƒ½æœ‰ sanitize
```

#### æ¨¡å¼ 3: æ¥å£å®ç°å…¨è¦†ç›–

```
ç›®æ ‡: å®¡è®¡ UserService æ¥å£çš„æ‰€æœ‰å®ç°

1. LSP goToImplementation(UserService.getUser)
2. è¿”å›: UserServiceImpl, AdminUserService, CacheUserService
3. å¯¹æ¯ä¸ªå®ç°è¿›è¡Œç‹¬ç«‹å®¡è®¡ (å¯èƒ½æœ‰ä¸åŒçš„æ¼æ´)
```

### LSP ä¸ Grep ååŒç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¡è®¡è¿½è¸ªç­–ç•¥                              â”‚
â”‚                                                             â”‚
â”‚  Phase 1: Grep å¹¿åº¦æœç´¢                                     â”‚
â”‚  â”œâ”€ å¿«é€Ÿå‘ç°æ½œåœ¨å±é™©ç‚¹                                       â”‚
â”‚  â””â”€ é€‚ç”¨äº: åˆå§‹ä¾¦å¯Ÿã€æ¨¡å¼åŒ¹é…                               â”‚
â”‚                                                             â”‚
â”‚  Phase 2: LSP æ·±åº¦åˆ†æ                                       â”‚
â”‚  â”œâ”€ ç²¾ç¡®è¿½è¸ªæ•°æ®æµ                                          â”‚
â”‚  â”œâ”€ åˆ†æè°ƒç”¨å…³ç³»                                            â”‚
â”‚  â””â”€ é€‚ç”¨äº: éªŒè¯æ¼æ´ã€è¿½è¸ªæ±¡ç‚¹                               â”‚
â”‚                                                             â”‚
â”‚  åŸåˆ™: Grep æ‰¾å¹¿åº¦ï¼ŒLSP æ±‚æ·±åº¦                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ³¨æ„äº‹é¡¹

1. **LSP éœ€è¦è¯­è¨€æœåŠ¡å™¨æ”¯æŒ**: ç¡®ä¿ç›®æ ‡è¯­è¨€çš„ LSP æœåŠ¡å™¨å·²é…ç½®
2. **è¡Œå·ä» 1 å¼€å§‹**: LSP ä½¿ç”¨ 1-based è¡Œå·å’Œåˆ—å·
3. **å¼‚æ­¥ç­‰å¾…**: å¤§å‹é¡¹ç›®ä¸­ LSP æ“ä½œå¯èƒ½éœ€è¦æ—¶é—´
4. **å›é€€ç­–ç•¥**: LSP ä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨ Grep + Read ç»„åˆ

---

## Sink Slot Type Classification (Slot ç±»å‹åˆ†ç±»)

> å€Ÿé‰´è‡ª Shannon æ¸—é€æµ‹è¯•å·¥å…·çš„ç²¾ç»†åŒ–åˆ†ææ–¹æ³•

### ä¸ºä»€ä¹ˆéœ€è¦ Slot åˆ†ç±»ï¼Ÿ

ä¸åŒçš„ sink ä½ç½®éœ€è¦ä¸åŒçš„é˜²æŠ¤æªæ–½ã€‚**å¸¸è§è¯¯åŒºæ˜¯è®¤ä¸º"å‚æ•°ç»‘å®šå¯ä»¥é˜²æ­¢æ‰€æœ‰ SQL æ³¨å…¥"**ï¼Œ
ä½†å‚æ•°ç»‘å®šåªèƒ½ä¿æŠ¤**å€¼ä½ç½®**ï¼Œä¸èƒ½ä¿æŠ¤**æ ‡è¯†ç¬¦ä½ç½®**ã€‚

### SQL Sink Slot ç±»å‹

| Slot Type | ä»£ç ç‰¹å¾ | æ­£ç¡®é˜²æŠ¤ | æ— æ•ˆé˜²æŠ¤ |
|-----------|----------|----------|----------|
| **SQL-val** | `WHERE col = ?` | å‚æ•°ç»‘å®š | - |
| **SQL-like** | `WHERE col LIKE ?` | å‚æ•°ç»‘å®š + è½¬ä¹‰ `%_` | ä»…å‚æ•°ç»‘å®š |
| **SQL-num** | `LIMIT ?`, `OFFSET ?` | parseInt/ç±»å‹è½¬æ¢ | å­—ç¬¦ä¸²ç»‘å®š |
| **SQL-enum** | `ORDER BY status` (å›ºå®šå€¼) | ç™½åå•éªŒè¯ | å‚æ•°ç»‘å®š |
| **SQL-ident** | `ORDER BY ${col}` (åŠ¨æ€åˆ—å) | **ç™½åå•** | å‚æ•°ç»‘å®šæ— æ•ˆ! |
| **SQL-table** | `FROM ${table}` (åŠ¨æ€è¡¨å) | **ç™½åå•** | å‚æ•°ç»‘å®šæ— æ•ˆ! |

### Command Injection Slot ç±»å‹

| Slot Type | ä»£ç ç‰¹å¾ | æ­£ç¡®é˜²æŠ¤ | æ— æ•ˆé˜²æŠ¤ |
|-----------|----------|----------|----------|
| **CMD-argument** | `cmd [arg1] [arg2]` | shell=False + æ•°ç»„ä¼ å‚ | é»‘åå•è¿‡æ»¤ |
| **CMD-part-of-string** | `"cmd ${input}"` | shlex.quote() / ç™½åå• | ç®€å•è½¬ä¹‰ |

### File Operation Slot ç±»å‹

| Slot Type | ä»£ç ç‰¹å¾ | æ­£ç¡®é˜²æŠ¤ | æ— æ•ˆé˜²æŠ¤ |
|-----------|----------|----------|----------|
| **FILE-path** | æ–‡ä»¶è·¯å¾„æ‹¼æ¥ | resolve() + è¾¹ç•Œæ£€æŸ¥ | `../` é»‘åå• |
| **FILE-include** | åŠ¨æ€æ–‡ä»¶åŒ…å« | ç™½åå•è·¯å¾„ | åè®®è¿‡æ»¤ |

### Template Slot ç±»å‹

| Slot Type | ä»£ç ç‰¹å¾ | æ­£ç¡®é˜²æŠ¤ | æ— æ•ˆé˜²æŠ¤ |
|-----------|----------|----------|----------|
| **TEMPLATE-content** | æ¨¡æ¿å†…å®¹æ¸²æŸ“ | autoescape | - |
| **TEMPLATE-expr** | æ¨¡æ¿è¡¨è¾¾å¼ `{{}}` | æ²™ç®± + ç¦æ­¢å±é™©æ–¹æ³• | ç®€å•è¿‡æ»¤ |

### Deserialization Slot ç±»å‹

| Slot Type | ä»£ç ç‰¹å¾ | æ­£ç¡®é˜²æŠ¤ | æ— æ•ˆé˜²æŠ¤ |
|-----------|----------|----------|----------|
| **DESERIALIZE-object** | ååºåˆ—åŒ–å…¥å£ | å¯ä¿¡æ¥æº + HMAC ç­¾å | ç±»å‹é»‘åå• |

### å®¡è®¡æ—¶çš„ Slot æ£€æŸ¥æµç¨‹

```
1. è¯†åˆ« Sink ç‚¹
2. ç¡®å®š Slot ç±»å‹ (val/ident/argument/path/...)
3. æ£€æŸ¥å®é™…ä½¿ç”¨çš„é˜²æŠ¤æªæ–½
4. éªŒè¯é˜²æŠ¤æªæ–½æ˜¯å¦åŒ¹é… Slot ç±»å‹
5. ä¸åŒ¹é… â†’ æŠ¥å‘Šæ½œåœ¨æ¼æ´
```

### ç¤ºä¾‹ï¼šSQL-ident Slot æ¼æ´

```java
// âŒ å±é™©: å‚æ•°ç»‘å®šä¸èƒ½ä¿æŠ¤ ORDER BY çš„åˆ—å
String col = request.getParameter("sort");
String sql = "SELECT * FROM users ORDER BY " + col;  // SQL-ident slot
PreparedStatement ps = conn.prepareStatement(sql);   // å‚æ•°ç»‘å®šæ— æ³•ä¿æŠ¤æ­¤å¤„!

// âœ… å®‰å…¨: ä½¿ç”¨ç™½åå•
String col = request.getParameter("sort");
List<String> allowed = Arrays.asList("name", "created_at", "id");
if (!allowed.contains(col)) {
    col = "id";  // é»˜è®¤å®‰å…¨å€¼
}
String sql = "SELECT * FROM users ORDER BY " + col;
```

---

## Post-Sanitization Concat Detection (å‡€åŒ–åæ‹¼æ¥æ£€æµ‹)

> å…³é”®è§„åˆ™: å¦‚æœ concat å‘ç”Ÿåœ¨ sanitization ä¹‹åï¼Œè¯¥å‡€åŒ–æªæ–½å¯èƒ½æ— æ•ˆ

### åæ¨¡å¼å®šä¹‰

"å‡€åŒ–åæ‹¼æ¥"æ˜¯æŒ‡ï¼šæ•°æ®ç»è¿‡å‡€åŒ–å‡½æ•°å¤„ç†åï¼Œåœ¨åˆ°è¾¾ sink ä¹‹å‰åˆä¸å…¶ä»–**æœªå‡€åŒ–æ•°æ®**æ‹¼æ¥ï¼Œ
æˆ–è€…å‡€åŒ–åçš„æ•°æ®è¢«é‡æ–°æ‹¼æ¥åˆ°å±é™©ä¸Šä¸‹æ–‡ä¸­ã€‚

### æ£€æµ‹æµç¨‹

```
1. å®šä½ sanitizer è°ƒç”¨: escape(), htmlspecialchars(), parameterize()
2. æ ‡è®°å‡€åŒ–åçš„å˜é‡ä¸º "sanitized"
3. è¿½è¸ªè¯¥å˜é‡åˆ° sink çš„è·¯å¾„
4. æ£€æŸ¥è·¯å¾„ä¸Šæ˜¯å¦æœ‰å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ
5. è‹¥æ‹¼æ¥å¼•å…¥äº†æœªå‡€åŒ–æ•°æ® â†’ æŠ¥å‘Šæ¼æ´
6. è‹¥å‡€åŒ–åæ•°æ®æ‹¼æ¥åˆ°ä¸åŒ¹é…çš„ä¸Šä¸‹æ–‡ â†’ æŠ¥å‘Šæ¼æ´
```

### å±é™©æ¨¡å¼ç¤ºä¾‹

**æ¨¡å¼ 1: å‡€åŒ–åä¸æœªå‡€åŒ–æ•°æ®æ‹¼æ¥**
```python
# user_id è¢«å‡€åŒ–ï¼Œä½† table æœªå‡€åŒ–
user_id = escape_sql(request.args.get('id'))     # sanitized
table = request.args.get('table')                 # NOT sanitized!
query = f"SELECT * FROM {table} WHERE id = {user_id}"  # å±é™©!
```

**æ¨¡å¼ 2: éƒ¨åˆ†å‚æ•°å‡€åŒ–**
```python
name = escape_sql(request.form['name'])           # sanitized
sort = request.form['sort']                       # NOT sanitized!
query = f"SELECT * FROM users WHERE name = '{name}' ORDER BY {sort}"  # å±é™©!
```

**æ¨¡å¼ 3: å‡€åŒ–ä¸Šä¸‹æ–‡ä¸åŒ¹é…**
```python
# HTML è½¬ä¹‰åç”¨äº JavaScript ä¸Šä¸‹æ–‡
user_input = html_escape(request.args.get('data'))  # HTML sanitized
script = f"<script>var data = '{user_input}';</script>"  # JS ä¸Šä¸‹æ–‡, HTML è½¬ä¹‰æ— æ•ˆ!
```

**æ¨¡å¼ 4: å‡€åŒ–ç»“æœè¢«äºŒæ¬¡å¤„ç†**
```python
data = escape_sql(user_input)                     # sanitized
data = data.replace("'", "")                      # åç»­å¤„ç†å¯èƒ½ç ´åå‡€åŒ–
query = f"SELECT * FROM users WHERE name = '{data}'"
```

### å®¡è®¡æ£€æŸ¥ç‚¹

- [ ] è¿½è¸ª**æ‰€æœ‰**åˆ°è¾¾ sink çš„å˜é‡ï¼Œä¸ä»…ä»…æ˜¯ç”¨æˆ·è¾“å…¥
- [ ] æ£€æŸ¥æ¯ä¸ªæ‹¼æ¥æ“ä½œæ˜¯å¦å¼•å…¥æ–°çš„æœªå‡€åŒ–æ•°æ®
- [ ] éªŒè¯å‡€åŒ–å‡½æ•°ä¸ sink ä¸Šä¸‹æ–‡æ˜¯å¦åŒ¹é…
- [ ] æ£€æŸ¥å‡€åŒ–åæ˜¯å¦æœ‰ç ´åæ€§çš„äºŒæ¬¡å¤„ç†
- [ ] ç‰¹åˆ«å…³æ³¨åŠ¨æ€æ„å»ºçš„ SQL/å‘½ä»¤/æ¨¡æ¿å­—ç¬¦ä¸²

### æŠ¥å‘Šæ ¼å¼

```yaml
vulnerability:
  type: "Post-Sanitization Concat"
  source: "request.args.get('table') @ app.py:10"
  sanitizer:
    location: "app.py:12"
    function: "escape_sql()"
    target: "user_id"
  post_sanitization_concat:
    location: "app.py:15"
    operation: "f-string concatenation"
    unsanitized_data: "table"
  sink:
    location: "app.py:16"
    function: "cursor.execute()"
  verdict: "vulnerable"
  reason: "æœªå‡€åŒ–çš„ table å˜é‡ä¸å‡€åŒ–åçš„ user_id æ‹¼æ¥è¿›å…¥ SQL æ‰§è¡Œ"
```

---

## Source & Sink Quick Reference

> å®Œæ•´çš„ Source/Sink å®šä¹‰è¯·å‚è€ƒ: `references/core/sinks_sources.md`

### å¸¸è§ Source (æ±¡ç‚¹æº)

| è¯­è¨€ | ä¸»è¦æ±¡ç‚¹æº |
|------|-----------|
| Java | `request.getParameter()`, `@RequestParam`, `@RequestBody` |
| Python | `request.args`, `request.form`, `request.json` |
| Go | `r.URL.Query()`, `c.Query()`, `c.PostForm()` |
| PHP | `$_GET`, `$_POST`, `$_REQUEST`, `$_COOKIE` |
| Node.js | `req.query`, `req.body`, `req.params` |

### å±é™© Sink åˆ†ç±»

| ç±»å‹ | ä¸¥é‡ç¨‹åº¦ | å…¸å‹å‡½æ•° |
|------|----------|----------|
| RCE | Critical | `exec()`, `system()`, `eval()` |
| ååºåˆ—åŒ– | Critical | `readObject()`, `pickle.loads()`, `unserialize()` |
| SQLæ³¨å…¥ | Critical | `executeQuery()`, `cursor.execute()`, `db.Query()` |
| SSRF | High | `URL.openConnection()`, `requests.get()`, `http.Get()` |
| XXE | High | `DocumentBuilder.parse()`, `SAXParser.parse()` |
| è·¯å¾„éå† | High | `new File()`, `open()`, `os.Open()` |
| XSS | Medium | `response.write()`, `echo`, `template.HTML()` |

### å¿«é€ŸæŸ¥è¯¢æ­£åˆ™

```regex
# é€šç”¨å±é™©å‡½æ•°
exec|system|eval|popen|shell_exec|passthru

# ååºåˆ—åŒ–
ObjectInputStream|pickle\.load|unserialize|Yaml\.load|JSON\.parse

# SQL
execute|executeQuery|createQuery|db\.Query|cursor\.execute

# æ–‡ä»¶æ“ä½œ
FileInputStream|FileOutputStream|file_get_contents|open\(|os\.Open
```

---

## Automated Taint Tracking (è‡ªåŠ¨åŒ–æ±¡ç‚¹è¿½è¸ª)

### è¿½è¸ªç®—æ³•

```
è¾“å…¥: æ¼æ´ä½ç½® (file:line)
è¾“å‡º: å®Œæ•´æ±¡ç‚¹åˆ†ææŠ¥å‘Š

ç®—æ³•æ­¥éª¤:
1. å®šä½Sink
   - è¯»å–æŒ‡å®šè¡Œä»£ç 
   - è¯†åˆ«å±é™©å‡½æ•°è°ƒç”¨
   - æå–æ¶‰åŠçš„å˜é‡

2. åå‘è¿½è¸ª (Backward Tracking)
   - ä»Sinkå˜é‡å¼€å§‹
   - é€è¡Œå‘ä¸ŠæŸ¥æ‰¾å˜é‡å®šä¹‰/èµ‹å€¼
   - è¯†åˆ«å‡½æ•°è°ƒç”¨ï¼Œè¿›å…¥å‡½æ•°ä½“ç»§ç»­è¿½è¸ª
   - è®°å½•æ¯ä¸ªä¼ æ’­èŠ‚ç‚¹

3. è¯†åˆ«Source
   - è¿½è¸ªç›´åˆ°æ‰¾åˆ°å¤–éƒ¨è¾“å…¥
   - æ ‡è®°Sourceç±»å‹å’Œä½ç½®

4. æ­£å‘éªŒè¯ (Forward Validation)
   - ä»Sourceå¼€å§‹æ­£å‘éå†
   - ç¡®è®¤ä¼ æ’­è·¯å¾„å®Œæ•´æ€§
   - æ£€æŸ¥æ˜¯å¦å­˜åœ¨å‡€åŒ–æ“ä½œ

5. ç”ŸæˆæŠ¥å‘Š
   - æ•´ç†Source/Sink/Propagation
   - åˆ†æå‡€åŒ–æƒ…å†µ
   - è¯„ä¼°åˆ©ç”¨å¯èƒ½æ€§
```

### è¿½è¸ªæ“ä½œæŒ‡å—

#### Step 1: å®šä½Sinkç‚¹

```
ç»™å®š: file.java:70 å­˜åœ¨æ¼æ´

æ“ä½œ:
1. Read file.java è·å–ç¬¬70è¡Œä¸Šä¸‹æ–‡
2. è¯†åˆ«å±é™©å‡½æ•°: stmt.executeQuery(query)
3. æå–Sinkå˜é‡: query
4. è®°å½•Sinkä¿¡æ¯
```

#### Step 2: åå‘æ•°æ®æµè¿½è¸ª

```
è¿½è¸ªå˜é‡: query

æ“ä½œ:
1. åœ¨å½“å‰å‡½æ•°å†…å‘ä¸Šæœç´¢ query çš„å®šä¹‰
2. æ‰¾åˆ°: String query = "SELECT * FROM users WHERE id=" + param (line 67)
3. æ–°å¢è¿½è¸ªå˜é‡: param
4. ç»§ç»­å‘ä¸Šæœç´¢ param çš„å®šä¹‰
5. æ‰¾åˆ°: String param = userId.trim() (line 52)
6. æ–°å¢è¿½è¸ªå˜é‡: userId
7. ç»§ç»­å‘ä¸Šæœç´¢ userId çš„å®šä¹‰
8. æ‰¾åˆ°: String userId = request.getParameter("id") (line 45)
9. è¯†åˆ«ä¸ºSource: HTTPå‚æ•°
```

#### Step 3: è·¨å‡½æ•°è¿½è¸ª

```
åœºæ™¯: å˜é‡æ¥è‡ªå‡½æ•°è°ƒç”¨

æ“ä½œ:
1. è¯†åˆ«å‡½æ•°è°ƒç”¨: result = processInput(userInput)
2. å®šä½å‡½æ•°å®šä¹‰: processInput() in utils.java:120
3. åˆ†æå‡½æ•°å‚æ•°å’Œè¿”å›å€¼
4. åœ¨å‡½æ•°ä½“å†…ç»§ç»­è¿½è¸ª
5. å¦‚æœè¿”å›å€¼åŒ…å«æ±¡ç‚¹ï¼Œæ ‡è®°ä¸ºä¼ æ’­
```

#### Step 4: å‡€åŒ–æ£€æŸ¥

```
åœ¨ä¼ æ’­è·¯å¾„ä¸Šæ£€æŸ¥:

1. è¾“å…¥éªŒè¯
   - ç™½åå•éªŒè¯: if (!allowed.contains(input)) return;
   - æ­£åˆ™åŒ¹é…: if (!input.matches("^[a-zA-Z0-9]+$")) return;
   - ç±»å‹è½¬æ¢: int id = Integer.parseInt(input);

2. ç¼–ç /è½¬ä¹‰
   - HTML: StringEscapeUtils.escapeHtml4(input)
   - SQL: PreparedStatement å‚æ•°åŒ–
   - å‘½ä»¤: ProcessBuilder (éshellæ¨¡å¼)
   - URL: URLEncoder.encode(input)

3. å®‰å…¨APIæ›¿æ¢
   - åŸç”ŸSQL â†’ ORMå‚æ•°åŒ–æŸ¥è¯¢
   - Runtime.exec â†’ ProcessBuilder
   - Stringæ‹¼æ¥ â†’ StringBuilder + éªŒè¯
```

### å·¥å…·è¾…åŠ©

#### ä½¿ç”¨Grepè¿½è¸ª

```bash
# æŸ¥æ‰¾å˜é‡å®šä¹‰
grep -n "variableName\s*=" file.ext

# æŸ¥æ‰¾å˜é‡ä½¿ç”¨
grep -n "variableName" file.ext

# æŸ¥æ‰¾å‡½æ•°å®šä¹‰
grep -n "def functionName\|function functionName\|func functionName" *.ext

# æŸ¥æ‰¾å‡½æ•°è°ƒç”¨
grep -rn "functionName(" --include="*.ext"
```

#### ä½¿ç”¨LSPè¿½è¸ª

```
æ“ä½œ:
1. goToDefinition: è·³è½¬åˆ°å˜é‡/å‡½æ•°å®šä¹‰
2. findReferences: æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨ä½ç½®
3. hover: è·å–ç±»å‹ä¿¡æ¯
4. incomingCalls: æŸ¥æ‰¾è°ƒç”¨è€…
5. outgoingCalls: æŸ¥æ‰¾è¢«è°ƒç”¨å‡½æ•°
```

---

## Function Context Analysis (å‡½æ•°ä¸Šä¸‹æ–‡åˆ†æ)

> å€Ÿé‰´è‡ª DeepAudit RAG ç³»ç»Ÿçš„ retrieve_function_context() æ–¹æ³•

### æ¦‚è¿°

å‡½æ•°ä¸Šä¸‹æ–‡åˆ†ææ˜¯æ±¡ç‚¹è¿½è¸ªçš„é‡è¦è¡¥å……ï¼Œé€šè¿‡åˆ†æå‡½æ•°çš„è°ƒç”¨è€…(callers)å’Œè¢«è°ƒç”¨è€…(callees)ï¼Œ
å»ºç«‹å®Œæ•´çš„è°ƒç”¨å…³ç³»å›¾ï¼Œè¯†åˆ«æ±¡ç‚¹ä¼ æ’­çš„å®Œæ•´è·¯å¾„ã€‚

### å‡½æ•°ä¸Šä¸‹æ–‡è¿½è¸ªæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Function Context Analysis                       â”‚
â”‚                                                                 â”‚
â”‚   Step 1: å®šä½ç›®æ ‡å‡½æ•°                                           â”‚
â”‚   â”œâ”€ ç¡®å®šå‡½æ•°åç§°å’Œæ‰€åœ¨æ–‡ä»¶                                       â”‚
â”‚   â””â”€ è¯»å–å‡½æ•°å®šä¹‰å’Œç­¾å                                          â”‚
â”‚                                                                 â”‚
â”‚   Step 2: è¿½è¸ªè°ƒç”¨è€… (Callers) - è°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°?                â”‚
â”‚   â”œâ”€ grep -rn "function_name\s*\(" --include="*.ext"            â”‚
â”‚   â”œâ”€ åˆ†æè°ƒç”¨ç‚¹çš„å‚æ•°æ¥æº                                        â”‚
â”‚   â””â”€ é€’å½’è¿½è¸ªç›´åˆ°æ‰¾åˆ°å¤–éƒ¨å…¥å£                                     â”‚
â”‚                                                                 â”‚
â”‚   Step 3: è¿½è¸ªè¢«è°ƒç”¨è€… (Callees) - è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†è°?              â”‚
â”‚   â”œâ”€ è¯»å–å‡½æ•°ä½“ï¼Œæå–æ‰€æœ‰å‡½æ•°è°ƒç”¨                                 â”‚
â”‚   â”œâ”€ è¯†åˆ«å±é™©å‡½æ•°è°ƒç”¨ (Sink)                                     â”‚
â”‚   â””â”€ åˆ†æå‚æ•°å¦‚ä½•ä¼ é€’ç»™è¢«è°ƒç”¨å‡½æ•°                                 â”‚
â”‚                                                                 â”‚
â”‚   Step 4: æ„å»ºè°ƒç”¨å›¾                                             â”‚
â”‚   â””â”€ å¯è§†åŒ–å®Œæ•´çš„è°ƒç”¨å…³ç³»                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è°ƒç”¨è€…è¿½è¸ª (Caller Analysis)

**ç›®æ ‡**: æ‰¾å‡ºæ‰€æœ‰è°ƒç”¨ç›®æ ‡å‡½æ•°çš„ä½ç½®ï¼Œè¿½è¸ªå‚æ•°æ¥æº

```bash
# Step 1: æœç´¢ç›´æ¥è°ƒç”¨
grep -rn "vulnerable_function\s*(" --include="*.py" --include="*.java" --include="*.js"

# Step 2: æœç´¢æ–¹æ³•è°ƒç”¨ (å¸¦å¯¹è±¡å‰ç¼€)
grep -rn "\.vulnerable_function\s*(" --include="*.py" --include="*.java"

# Step 3: æœç´¢å¯¼å…¥/å¼•ç”¨å…³ç³»
grep -rn "from.*import.*vulnerable_function\|import.*vulnerable_function" --include="*.py"
grep -rn "require.*vulnerable_function\|import.*vulnerable_function" --include="*.js"
```

**åˆ†æè¦ç‚¹**:
```
å¯¹æ¯ä¸ªè°ƒç”¨ç‚¹:
1. è°ƒç”¨å‚æ•°æ˜¯ä»€ä¹ˆ?
   - ç¡¬ç¼–ç å¸¸é‡ â†’ å®‰å…¨
   - å±€éƒ¨å˜é‡ â†’ ç»§ç»­è¿½è¸ªå˜é‡æ¥æº
   - å‡½æ•°å‚æ•° â†’ ç»§ç»­è¿½è¸ªè°ƒç”¨è€…
   - ç”¨æˆ·è¾“å…¥ â†’ æ‰¾åˆ° Source!

2. è°ƒç”¨ä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆ?
   - åœ¨ Controller/Handler ä¸­ â†’ å¯èƒ½æ˜¯å…¥å£ç‚¹
   - åœ¨ Service/Util ä¸­ â†’ ç»§ç»­è¿½è¸ª
   - åœ¨æµ‹è¯•ä»£ç ä¸­ â†’ é€šå¸¸å¯å¿½ç•¥
```

### è¢«è°ƒç”¨è€…è¿½è¸ª (Callee Analysis)

**ç›®æ ‡**: åˆ†æå‡½æ•°å†…éƒ¨è°ƒç”¨äº†å“ªäº›å…¶ä»–å‡½æ•°ï¼Œæ˜¯å¦åˆ°è¾¾å±é™© Sink

```
åˆ†ææ­¥éª¤:
1. è¯»å–å‡½æ•°å®Œæ•´ä»£ç 
2. æå–æ‰€æœ‰å‡½æ•°è°ƒç”¨
3. åˆ†ç±»:
   â”œâ”€ å±é™©å‡½æ•° (Sink) â†’ æ ‡è®°é£é™©
   â”œâ”€ æ•°æ®å¤„ç†å‡½æ•° â†’ åˆ†ææ˜¯å¦ä¼ é€’æ±¡ç‚¹
   â”œâ”€ éªŒè¯å‡½æ•° â†’ æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆå‡€åŒ–
   â””â”€ å·¥å…·å‡½æ•° â†’ é€’å½’åˆ†æ
```

**ç¤ºä¾‹**:
```python
def process_user_data(user_input):
    # Callee 1: æ•°æ®å¤„ç†
    cleaned = sanitize(user_input)      # éœ€è¦åˆ†æ sanitize() æ˜¯å¦æœ‰æ•ˆ

    # Callee 2: æ•°æ®åº“æ“ä½œ
    query = build_query(cleaned)        # éœ€è¦åˆ†æ build_query() æ˜¯å¦å®‰å…¨

    # Callee 3: æ‰§è¡ŒæŸ¥è¯¢ (Sink)
    result = db.execute(query)          # å±é™©! å¦‚æœ query åŒ…å«æ±¡ç‚¹

    return result
```

### è°ƒç”¨å›¾æ„å»º

```
å¯è§†åŒ–è°ƒç”¨å…³ç³»:

                    [HTTP Handler]
                          â”‚
                          â–¼
[caller_1] â”€â”€â”¬â”€â”€â–º [target_function] â”€â”€â”¬â”€â”€â–º [callee_1: validator]
             â”‚                        â”‚
[caller_2] â”€â”€â”¤                        â”œâ”€â”€â–º [callee_2: transformer]
             â”‚                        â”‚
[caller_3] â”€â”€â”˜                        â””â”€â”€â–º [callee_3: db.execute] â† Sink!

è°ƒç”¨é“¾ç¤ºä¾‹:
Controller.handleRequest()
    â””â”€â”€â–º UserService.processUser(userId)
            â””â”€â”€â–º UserMapper.selectUser(userId)
                    â””â”€â”€â–º SQLæ‰§è¡Œ (Sink)
```

### è·¨æ–‡ä»¶å‡½æ•°è¿½è¸ª

```
åœºæ™¯: å‡½æ•°å®šä¹‰å’Œè°ƒç”¨åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶

è¿½è¸ªç­–ç•¥:
1. å®šä½å‡½æ•°å®šä¹‰æ–‡ä»¶
   grep -rn "def function_name\|function function_name\|public.*function_name" --include="*.py" --include="*.js" --include="*.java"

2. æœç´¢æ‰€æœ‰è°ƒç”¨ç‚¹
   grep -rn "function_name\s*(" --include="*.py" --include="*.js" --include="*.java"

3. åˆ†æå¯¼å…¥å…³ç³»
   - Python: from module import function
   - Java: import package.Class
   - JavaScript: require/import

4. æ„å»ºè·¨æ–‡ä»¶è°ƒç”¨é“¾
   file_a.py:10 â†’ file_b.py:25 â†’ file_c.py:42 â†’ Sink
```

### é€’å½’æ·±åº¦æ§åˆ¶

```
å‚æ•°é…ç½®:
- max_depth: æœ€å¤§è¿½è¸ªæ·±åº¦ (æ¨è: 10)
- top_k: æ¯å±‚è¿”å›çš„æœ€å¤§ç»“æœæ•° (æ¨è: 10)

æ·±åº¦æ§åˆ¶ç­–ç•¥:
1. ä¼˜å…ˆè¿½è¸ªé«˜é£é™©è·¯å¾„
2. é‡åˆ°å¾ªç¯è°ƒç”¨æ—¶æ ‡è®°å¹¶è·³è¿‡
3. è¾¾åˆ°æœ€å¤§æ·±åº¦æ—¶åœæ­¢å¹¶æŠ¥å‘Š
4. é‡åˆ°æ¡†æ¶/åº“å‡½æ•°æ—¶æ ‡è®°è¾¹ç•Œ
```

### ä¸Šä¸‹æ–‡åˆ†ææ¨¡æ¿

```markdown
## å‡½æ•°ä¸Šä¸‹æ–‡åˆ†ææŠ¥å‘Š

### ç›®æ ‡å‡½æ•°
- **åç§°**: function_name()
- **ä½ç½®**: path/to/file.ext:line
- **ç­¾å**: def function_name(param1, param2)

### è°ƒç”¨è€…åˆ†æ (è°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°)

| è°ƒç”¨ä½ç½® | å‚æ•°æ¥æº | é£é™©è¯„ä¼° |
|----------|----------|----------|
| caller1.py:20 | ç”¨æˆ·è¾“å…¥ request.args | é«˜é£é™© |
| caller2.py:45 | å†…éƒ¨å¸¸é‡ | å®‰å…¨ |
| caller3.py:80 | æ•°æ®åº“æŸ¥è¯¢ç»“æœ | éœ€éªŒè¯ |

### è¢«è°ƒç”¨è€…åˆ†æ (è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†è°)

| è¢«è°ƒç”¨å‡½æ•° | è°ƒç”¨ä½ç½® | ç±»å‹ | é£é™© |
|------------|----------|------|------|
| sanitize() | line 5 | å‡€åŒ–å‡½æ•° | éœ€éªŒè¯æœ‰æ•ˆæ€§ |
| db.query() | line 12 | Sink | é«˜é£é™© |
| log.info() | line 15 | æ—¥å¿— | ä½é£é™© |

### å®Œæ•´è°ƒç”¨é“¾

```
[Entry] request.args.get('id')
    â†“
[Caller] UserController.get_user(id) line:30
    â†“
[Target] UserService.find_by_id(id) line:15
    â†“
[Callee] db.query("SELECT * FROM users WHERE id=" + id) line:20  â† Sink!
```

### é£é™©ç»“è®º
- è°ƒç”¨é“¾å­˜åœ¨ä» Source åˆ° Sink çš„æ±¡ç‚¹ä¼ æ’­
- ä¸­é—´æ— æœ‰æ•ˆå‡€åŒ–æªæ–½
- å»ºè®®: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
```

---

## Propagation Rules (ä¼ æ’­è§„åˆ™)

### æ±¡ç‚¹ä¼ æ’­æƒ…å†µ

| æ“ä½œç±»å‹ | ä¼ æ’­è§„åˆ™ | ç¤ºä¾‹ |
|----------|----------|------|
| èµ‹å€¼ | æ±¡ç‚¹ä¼ é€’ | `b = a` (aæ±¡ç‚¹â†’bæ±¡ç‚¹) |
| å­—ç¬¦ä¸²æ‹¼æ¥ | æ±¡ç‚¹ä¼ é€’ | `c = a + b` (ä»»ä¸€æ±¡ç‚¹â†’cæ±¡ç‚¹) |
| å‡½æ•°å‚æ•° | æ±¡ç‚¹ä¼ é€’ | `func(a)` (aæ±¡ç‚¹â†’å‚æ•°æ±¡ç‚¹) |
| å‡½æ•°è¿”å› | æ¡ä»¶ä¼ é€’ | è¿”å›å€¼æ˜¯å¦åŒ…å«å‚æ•°æ±¡ç‚¹ |
| æ•°ç»„/å¯¹è±¡ | å…ƒç´ ä¼ é€’ | `arr[0] = a` (aæ±¡ç‚¹â†’arræ±¡ç‚¹) |
| ç±»å‹è½¬æ¢ | å¯èƒ½å‡€åŒ– | `int(a)` å¯èƒ½æŠ›å¼‚å¸¸å‡€åŒ– |
| ç¼–ç /è½¬ä¹‰ | å¯èƒ½å‡€åŒ– | `escape(a)` æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­ |

### æ±¡ç‚¹æ¶ˆé™¤æƒ…å†µ

| æ¶ˆé™¤æ–¹å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|----------|------|------|
| å¸¸é‡æ›¿æ¢ | è¢«å¸¸é‡è¦†ç›– | `a = "fixed"` |
| ç™½åå•éªŒè¯ | åœ¨å…è®¸åˆ—è¡¨ä¸­ | `if a in whitelist` |
| ç±»å‹å¼ºåˆ¶è½¬æ¢ | è½¬ä¸ºå®‰å…¨ç±»å‹ | `int(a)` éæ•°å­—æŠ›å¼‚å¸¸ |
| é€‚å½“çš„ç¼–ç  | é’ˆå¯¹Sinkçš„ç¼–ç  | SQLå‚æ•°åŒ–ã€HTMLå®ä½“ |
| å®‰å…¨API | ä½¿ç”¨å®‰å…¨æ›¿ä»£ | PreparedStatement |

---

## Report Examples (æŠ¥å‘Šç¤ºä¾‹)

### SQLæ³¨å…¥ç¤ºä¾‹

```markdown
## [Critical] SQLæ³¨å…¥ - UserController.java:70

### åŸºæœ¬ä¿¡æ¯
| å±æ€§ | å€¼ |
|------|-----|
| æ¼æ´ç±»å‹ | SQLæ³¨å…¥ |
| ä¸¥é‡ç¨‹åº¦ | Critical |
| CWEç¼–å· | CWE-89 |
| æ–‡ä»¶ä½ç½® | src/main/java/com/app/controller/UserController.java:70 |
| å‡½æ•°åç§° | getUserById() |

---

### Source (æ±¡ç‚¹æº)

**ä½ç½®**: `UserController.java:45`

**ç±»å‹**: HTTPè¯·æ±‚å‚æ•°

**ä»£ç **:
```java
String userId = request.getParameter("id");
```

**è¯´æ˜**: ç”¨æˆ·é€šè¿‡URLå‚æ•°ç›´æ¥æ§åˆ¶userIdå€¼ï¼Œæ— ä»»ä½•è¾“å…¥éªŒè¯

---

### Taint Propagation (æ±¡ç‚¹ä¼ æ’­è·¯å¾„)

```
[1] UserController.java:45
    ä»£ç : String userId = request.getParameter("id")
    æ“ä½œ: æ±¡ç‚¹å¼•å…¥ - HTTPå‚æ•°è¿›å…¥å˜é‡
    â†“
[2] UserController.java:52
    ä»£ç : String param = userId.trim()
    æ“ä½œ: æ±¡ç‚¹ä¼ é€’ - trim()ä¸æ”¹å˜æ±¡ç‚¹æ€§è´¨
    â†“
[3] UserController.java:67
    ä»£ç : String query = "SELECT * FROM users WHERE id=" + param
    æ“ä½œ: æ±¡ç‚¹æ‹¼æ¥ - æ±¡ç‚¹æ•°æ®æ‹¼æ¥åˆ°SQLè¯­å¥
    â†“
[4] UserController.java:70
    ä»£ç : ResultSet rs = stmt.executeQuery(query)
    æ“ä½œ: æ±¡ç‚¹åˆ°è¾¾Sink - æ‰§è¡ŒåŒ…å«æ±¡ç‚¹çš„SQL
```

**ä¼ æ’­é“¾æ‘˜è¦**:
- æ€»è·¨åº¦: 25è¡Œä»£ç  / 1ä¸ªå‡½æ•° / 1ä¸ªæ–‡ä»¶
- ä¸­é—´å˜é‡: userId â†’ param â†’ query
- æ— è·¨å‡½æ•°è°ƒç”¨

---

### Sink (æ±‡èšç‚¹)

**ä½ç½®**: `UserController.java:70`

**ç±»å‹**: SQLæ‰§è¡Œ (Statement.executeQuery)

**ä»£ç **:
```java
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery(query);
```

**å±å®³**:
- æ”»å‡»è€…å¯å®ç°: ä»»æ„SQLæ‰§è¡Œï¼ŒåŒ…æ‹¬æ•°æ®æŸ¥è¯¢ã€ä¿®æ”¹ã€åˆ é™¤
- å½±å“èŒƒå›´: æ•´ä¸ªæ•°æ®åº“ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æ•°æ®ç¯¡æ”¹ã€æƒé™æå‡

---

### Taint Analysis (æ±¡ç‚¹åˆ†æç»“è®º)

| åˆ†æé¡¹ | ç»“æœ |
|--------|------|
| æ±¡ç‚¹æºå¯æ§æ€§ | å®Œå…¨å¯æ§ |
| å­˜åœ¨å‡€åŒ–æªæ–½ | æ—  |
| ç»•è¿‡å¯èƒ½æ€§ | é«˜ |
| åˆ©ç”¨å¤æ‚åº¦ | ç®€å• |
| éœ€è¦è®¤è¯ | å¦ |

**å‡€åŒ–æ£€æŸ¥**:
- [x] è¾“å…¥éªŒè¯: æ— 
- [x] ç¼–ç è½¬ä¹‰: æ— 
- [x] ç±»å‹è½¬æ¢: æ—  (trim()ä¸æ˜¯æœ‰æ•ˆå‡€åŒ–)

**æ”»å‡»å‘é‡**:
```
GET /api/user?id=1' OR '1'='1
GET /api/user?id=1' UNION SELECT username,password,null FROM admin--
```

---

### PoC (æ¦‚å¿µéªŒè¯)

**å‰ç½®æ¡ä»¶**: æ— éœ€è®¤è¯ï¼Œå…¬å¼€è®¿é—®æ¥å£

**åˆ©ç”¨æ­¥éª¤**:
1. è®¿é—® /api/user?id=1 ç¡®è®¤æ­£å¸¸åŠŸèƒ½
2. è®¿é—® /api/user?id=1' è§‚å¯Ÿé”™è¯¯ä¿¡æ¯
3. ä½¿ç”¨ UNION æ³¨å…¥è·å–å…¶ä»–è¡¨æ•°æ®

**Payload**:
```
/api/user?id=1' UNION SELECT username,password,email FROM admin--
```

**é¢„æœŸç»“æœ**: è¿”å›adminè¡¨ä¸­çš„ç”¨æˆ·åå’Œå¯†ç 

---

### ä¿®å¤å»ºè®®

**æ¨èæ–¹æ¡ˆ**: ä½¿ç”¨PreparedStatementå‚æ•°åŒ–æŸ¥è¯¢
```java
String sql = "SELECT * FROM users WHERE id = ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1, userId);
ResultSet rs = pstmt.executeQuery();
```

**æ›¿ä»£æ–¹æ¡ˆ**:
- ä½¿ç”¨ORMæ¡†æ¶ (MyBatiså‚æ•°åŒ–ã€JPA)
- è¾“å…¥éªŒè¯ (ä»…å…è®¸æ•°å­—)

**ä¿®å¤åŸåˆ™**:
1. æ°¸è¿œä¸è¦æ‹¼æ¥SQLè¯­å¥
2. ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ–ORM
3. å¯¹äºåŠ¨æ€è¡¨å/åˆ—åï¼Œä½¿ç”¨ç™½åå•éªŒè¯

---

### å‚è€ƒèµ„æ–™
- CWE-89: https://cwe.mitre.org/data/definitions/89.html
- OWASP SQL Injection: https://owasp.org/www-community/attacks/SQL_Injection
```

---

## Integration with Audit Workflow

### è§¦å‘æ—¶æœº

```
åœ¨æ ‡å‡†å®¡è®¡æµç¨‹ä¸­ï¼Œå½“å‘ç°æ¼æ´æ—¶:

1. ä½¿ç”¨Grep/Globå®šä½å±é™©æ¨¡å¼
2. å‘ç°æ½œåœ¨æ¼æ´ç‚¹ (Sink)
3. **è§¦å‘æ±¡ç‚¹åˆ†æ**
4. åå‘è¿½è¸ªåˆ°Source
5. éªŒè¯ä¼ æ’­è·¯å¾„
6. æ£€æŸ¥å‡€åŒ–æªæ–½
7. ç”Ÿæˆæ±¡ç‚¹åˆ†ææŠ¥å‘Š
```

### å‘½ä»¤è§¦å‘

```
ç”¨æˆ·è¾“å…¥æ ¼å¼:
- "åˆ†æ file.java:70 çš„æ±¡ç‚¹æµ"
- "è¿½è¸ª path/to/file.py:123 çš„æ•°æ®æ¥æº"
- "ç”Ÿæˆ src/handler.go:45 çš„æ±¡ç‚¹æŠ¥å‘Š"

è‡ªåŠ¨è¯†åˆ«:
- æ–‡ä»¶è·¯å¾„
- è¡Œå·
- å¯åŠ¨æ±¡ç‚¹è¿½è¸ªæµç¨‹
```

---

## Best Practices

### è¿½è¸ªåŸåˆ™

1. **å®Œæ•´æ€§**: è¿½è¸ªç›´åˆ°ç¡®è®¤Sourceï¼Œä¸è¦ä¸­é€”åœæ­¢
2. **å‡†ç¡®æ€§**: æ¯ä¸ªä¼ æ’­èŠ‚ç‚¹éƒ½éœ€è¦ä»£ç éªŒè¯
3. **å…¨é¢æ€§**: æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ä¼ æ’­è·¯å¾„
4. **å®ç”¨æ€§**: å…³æ³¨å¯åˆ©ç”¨çš„è·¯å¾„ï¼Œå¿½ç•¥ç†è®ºé£é™©

### å¸¸è§é™·é˜±

1. **å¿½ç•¥é—´æ¥ä¼ æ’­**: é€šè¿‡å…¨å±€å˜é‡ã€æ•°æ®åº“ã€æ–‡ä»¶çš„é—´æ¥ä¼ æ’­
2. **è¯¯åˆ¤å‡€åŒ–**: æŸäº›"å‡€åŒ–"æ“ä½œå¯èƒ½è¢«ç»•è¿‡
3. **è·¨è¯·æ±‚æ±¡ç‚¹**: å­˜å‚¨å‹æ¼æ´çš„è·¨è¯·æ±‚æ•°æ®æµ
4. **æ¡†æ¶é­”æ³•**: æ¡†æ¶è‡ªåŠ¨ç»‘å®šçš„éšå¼æ•°æ®æµ

### æ•ˆç‡æŠ€å·§

1. å…ˆè¯†åˆ«Sinkç±»å‹ï¼Œç¡®å®šéœ€è¦è¿½è¸ªçš„å±é™©ç¨‹åº¦
2. ä½¿ç”¨IDE/LSPçš„è·³è½¬åŠŸèƒ½åŠ é€Ÿè¿½è¸ª
3. ç†Ÿæ‚‰æ¡†æ¶çš„æ•°æ®ç»‘å®šæœºåˆ¶
4. å»ºç«‹å¸¸è§Source-Sinkæ¨¡å¼åº“

---

## References (å‚è€ƒèµ„æº)

### å·¥å…·å‚è€ƒ

| å·¥å…· | è¯­è¨€ | é“¾æ¥ |
|------|------|------|
| JavaSinkTracer | Java | https://github.com/Tr0e/JavaSinkTracer |
| CodeQL | å¤šè¯­è¨€ | https://codeql.github.com/ |
| Semgrep | å¤šè¯­è¨€ | https://semgrep.dev/ |
| Gosec | Go | https://github.com/securego/gosec |
| Bandit | Python | https://github.com/PyCQA/bandit |

### ç†è®ºå‚è€ƒ

- [CWE - Common Weakness Enumeration](https://cwe.mitre.org/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [Taint Analysis Wikipedia](https://en.wikipedia.org/wiki/Taint_checking)

## ğŸš€ æ”¹è¿›çš„ä¼ æ’­è·¯å¾„åˆ†æ (åŸºäºRuoYiå®¡è®¡ç»éªŒ)

### æ–°å¢ä¼ æ’­æ¨¡å¼

#### 1. æ³¨è§£é©±åŠ¨çš„æ•°æ®è¿‡æ»¤ä¼ æ’­
```
HTTPè¯·æ±‚ â†’ Controller â†’ @DataScopeæ³¨è§£æ–¹æ³• â†’ AOPåˆ‡é¢å¤„ç† â†’ SQLæ‹¼æ¥ â†’ ${}å‚æ•°æ›¿æ¢
```

**æ£€æµ‹è¦ç‚¹:**
- æ‰«ææ‰€æœ‰ä½¿ç”¨`@DataScope`æ³¨è§£çš„æ–¹æ³•
- è¿½è¸ªAOPåˆ‡é¢ä¸­çš„SQLæ‹¼æ¥é€»è¾‘
- éªŒè¯æ³¨è§£å‚æ•°çš„å¯æ§æ€§

#### 2. æ¡†æ¶ç‰¹å®šçš„ä¼ æ’­è·¯å¾„
```
HTTPè¯·æ±‚ â†’ Controllerå‚æ•° â†’ Serviceè°ƒç”¨ â†’ @DataScopeå¤„ç† â†’ Mapperæ‰§è¡Œ
```

**æ£€æµ‹è¦ç‚¹:**
- è¯†åˆ«æ¡†æ¶ç‰¹å®šçš„æ•°æ®æµæ¨¡å¼
- æ£€æŸ¥æƒé™æ³¨è§£çš„å®‰å…¨æ€§
- éªŒè¯æ•°æ®èŒƒå›´è¿‡æ»¤çš„å®ç°

### å¢å¼ºçš„éªŒè¯æ­¥éª¤

#### æ³¨è§£å¤„ç†å®‰å…¨æ€§éªŒè¯
- ç¡®è®¤`@DataScope`æ³¨è§£çš„å‚æ•°æ¥æº
- æ£€æŸ¥AOPåˆ‡é¢ä¸­çš„è¾“å…¥è¿‡æ»¤
- éªŒè¯æƒé™éªŒè¯é€»è¾‘çš„å®Œæ•´æ€§

#### æ–¹æ³•è°ƒç”¨é“¾åˆ†æ
- è¿½è¸ªServiceå±‚æ–¹æ³•é—´çš„å‚æ•°ä¼ é€’
- æ£€æŸ¥å¯¼å‡ºåŠŸèƒ½çš„æ•°æ®æµè·¯å¾„
- éªŒè¯é—´æ¥è°ƒç”¨çš„å®‰å…¨æ€§

### æ–°å¢æ£€æµ‹ç­–ç•¥

```markdown
### æ¡†æ¶åº”ç”¨å®¡è®¡æµç¨‹

1. **å…¥å£ç‚¹è¯†åˆ«**
   - æ‰«ææ‰€æœ‰Controlleræ¥å£
   - è¯†åˆ«HTTPæ–¹æ³•å’Œè·¯å¾„æ˜ å°„

2. **ä¼ æ’­è·¯å¾„è¿½è¸ª**
   - è¿½è¸ªServiceå±‚æ–¹æ³•è°ƒç”¨
   - è¯†åˆ«æ³¨è§£é©±åŠ¨çš„æ•°æ®è¿‡æ»¤
   - æ£€æŸ¥AOPåˆ‡é¢å¤„ç†é€»è¾‘

3. **æ±‡èšç‚¹è¯†åˆ«**
   - æ£€æŸ¥Mapper.xmlä¸­çš„${}ä½¿ç”¨
   - éªŒè¯SQLè¯­å¥çš„å®‰å…¨æ€§
   - ç¡®è®¤å‚æ•°åŒ–æŸ¥è¯¢çš„æ­£ç¡®æ€§

4. **é£é™©éªŒè¯**
   - ç¡®è®¤æ•°æ®æµå®Œæ•´æ€§
   - è¯„ä¼°å®é™…å¯åˆ©ç”¨æ€§
   - æä¾›å…·ä½“ä¿®å¤å»ºè®®
```

---

### æ–°å¢ï¼šæ–‡ä»¶æ“ä½œæ±¡ç‚¹è¿½è¸ª

#### æ–‡ä»¶æ“ä½œä¼ æ’­è·¯å¾„
```
HTTPè¯·æ±‚ â†’ @RequestParam/@PathVariable â†’ è·¯å¾„æ‹¼æ¥ â†’ æ–‡ä»¶ç³»ç»Ÿæ“ä½œ â†’ æ•æ„Ÿæ–‡ä»¶æ³„éœ²
```

**å…³é”®æ£€æµ‹èŠ‚ç‚¹:**
1. **Source**: `@RequestParam("fileName")`, `@PathVariable("file")`
2. **ä¼ æ’­**: è·¯å¾„æ‹¼æ¥æ“ä½œ (`basePath + fileName`)
3. **Sink**: `new File()`, `FileInputStream()`, `Paths.get()`

#### æ–‡ä»¶ä¸Šä¼ ä¼ æ’­è·¯å¾„
```
MultipartFile â†’ æ–‡ä»¶åè·å– â†’ è·¯å¾„æ‹¼æ¥ â†’ æ–‡ä»¶å­˜å‚¨ â†’ æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿ
```

#### æ£€æµ‹ç­–ç•¥
```bash
# æ–‡ä»¶æ“ä½œæ±¡ç‚¹è¿½è¸ªæµç¨‹
# 1. è¯†åˆ«æ–‡ä»¶æ“ä½œæ¥å£
grep -rn "@GetMapping.*file\|@PostMapping.*file" --include="*.java"

# 2. è¿½è¸ªå‚æ•°ä¼ é€’è·¯å¾„
grep -rn "fileName\|filePath\|path.*\+" --include="*.java"

# 3. è¯†åˆ«æ–‡ä»¶æ“ä½œSinkç‚¹
grep -rn "new File\|FileInputStream\|FileOutputStream" --include="*.java"

# 4. éªŒè¯å®‰å…¨é˜²æŠ¤æªæ–½
grep -rn "contains.*\\.\\.\|normalize\|startsWith" --include="*.java"
```

---

## äºŒæ¬¡æ³¨å…¥æ£€æµ‹æµç¨‹ (Second-Order Injection)

### æ ¸å¿ƒæ¦‚å¿µ

**ä¸€æ¬¡æ³¨å…¥**: ç”¨æˆ·è¾“å…¥ â†’ ç›´æ¥è¿›å…¥å±é™©æ“ä½œ â†’ æ¼æ´

**äºŒæ¬¡æ³¨å…¥**: ç”¨æˆ·è¾“å…¥ â†’ å­˜å‚¨åˆ°æ•°æ®åº“/ç¼“å­˜/æ–‡ä»¶ â†’ å–å‡º â†’ æœªç»å‡€åŒ– â†’ å±é™©æ“ä½œ â†’ æ¼æ´

å…³é”®ç‰¹å¾ï¼š**æ•°æ®ç»è¿‡å­˜å‚¨å±‚ä¸­è½¬ï¼Œå­˜åœ¨æ—¶é—´å·®å’Œç©ºé—´å·®**

### å…¸å‹æ”»å‡»åœºæ™¯

#### åœºæ™¯1: ORMå¯¹è±¡å±æ€§æ³¨å…¥
```java
// æ”»å‡»è€…è¾“å…¥: user.setBio("'; DROP TABLE users;--")

// å­˜å‚¨é˜¶æ®µï¼ˆä¸€æ¬¡ï¼‰- ç”¨æˆ·è¾“å…¥è¢«å­˜å…¥æ•°æ®åº“
@PostMapping("/profile")
public void updateProfile(@RequestBody User user) {
    userService.save(user);  // æ•°æ®å­˜å…¥æ•°æ®åº“ï¼Œæœªå‡€åŒ–
}

// å–å‡ºé˜¶æ®µï¼ˆäºŒæ¬¡ï¼‰- ä»æ•°æ®åº“å–å‡ºåç›´æ¥ä½¿ç”¨
@GetMapping("/search")
public void search(@RequestParam String keyword) {
    User user = userService.findById(userId);
    // âŒ å±é™©: user.getBio() å¯èƒ½åŒ…å«æ¶æ„SQL
    String sql = "SELECT * FROM posts WHERE content LIKE '%" + user.getBio() + "%'";
    stmt.executeQuery(sql);
}
```

#### åœºæ™¯2: å¯¹è±¡getteré“¾å¼è°ƒç”¨
```java
// sinkè°ƒç”¨äº† user.getProfile().getBio()
// éœ€è¦è¿½æº¯: userå¯¹è±¡ä»å“ªé‡Œæ¥? Profileå¯¹è±¡å¦‚ä½•è®¾ç½®?

@GetMapping("/export")
public void export(HttpServletResponse response) {
    User user = userService.findById(userId);
    Order order = orderService.findById(orderId);
    
    // âŒ å±é™©: ä»å®ä½“å¯¹è±¡ä¸­è·å–çš„å­—æ®µå¯èƒ½æ¥è‡ªæ•°æ®åº“
    String fileName = order.getProduct().getName() + ".csv";
    // å¯èƒ½å­˜åœ¨é—®é¢˜: productçš„nameå­—æ®µæ˜¯å¦ç»è¿‡å‡€åŒ–?
}
```

#### åœºæ™¯3: ç¼“å­˜æ•°æ®æ³¨å…¥
```java
// å­˜å…¥
redisTemplate.opsForValue().set("user:bio:" + userId, userInput);

// å–å‡ºåç›´æ¥ä½¿ç”¨
String bio = redisTemplate.opsForValue().get("user:bio:" + userId);
response.getWriter().write(bio);  // âŒ XSS
```

### æ£€æµ‹æµç¨‹

#### Step 1: è¯†åˆ«Sinkç‚¹ï¼ˆå±é™©æ“ä½œï¼‰
```
ç›®æ ‡: æ‰¾åˆ°æ‰€æœ‰å±é™©å‡½æ•°è°ƒç”¨
- SQLæ‰§è¡Œ: executeQuery, executeUpdate, createQuery
- å‘½ä»¤æ‰§è¡Œ: exec, Runtime.exec, ProcessBuilder
- æ–‡ä»¶æ“ä½œ: FileInputStream, FileReader
- å“åº”è¾“å‡º: getWriter().write, out.print
- æ¨¡æ¿æ¸²æŸ“: Model.addAttribute, ModelAndView
```

#### Step 2: è¿½è¸ªæ•°æ®æ¥æºï¼ˆåå‘è¿½æº¯ï¼‰
```
å¯¹äºæ¯ä¸ªSinkç‚¹ï¼Œå‘ä¸Šè¿½æº¯æ•°æ®æ¥æº:

1. ç›´æ¥æ¥æº: request.getParameter() â†’ ä¸€æ¬¡æ³¨å…¥
2. é—´æ¥æ¥æº: 
   - user.getXxx() â†’ æŸ¥æ‰¾userå¯¹è±¡å¦‚ä½•è·å–
   - entity.getProfile().getXxx() â†’ è¿½è¸ªæ•´ä¸ªå¯¹è±¡é“¾
   - cache.get(key) â†’ æŸ¥æ‰¾ç¼“å­˜å¦‚ä½•è®¾ç½®
```

#### Step 3: éªŒè¯å­˜å‚¨è·¯å¾„ï¼ˆå…³é”®æ­¥éª¤ï¼‰
```
å¦‚æœæ•°æ®æ¥è‡ªå¯¹è±¡çš„getterï¼Œéœ€è¦:

1. æ‰¾åˆ°å¯¹è±¡çš„setter/Xxx()æ–¹æ³•
   - user.setBio() / user.bio()
   - æœç´¢: "set" + capitalize(fieldName)
   
2. è¿½è¸ªsetterçš„è°ƒç”¨è·¯å¾„
   - æŸ¥æ‰¾å“ªé‡Œè°ƒç”¨äº† user.setBio(input)
   - è¾“å…¥æ˜¯å¦æ¥è‡ªHTTPè¯·æ±‚?
   
3. æ£€æŸ¥æ•°æ®åº“æ“ä½œ
   - INSERT/UPDATE æ—¶æ˜¯å¦å¯¹è¾“å…¥è¿›è¡Œäº†å‡€åŒ–?
   - ä½¿ç”¨ #{} (å‚æ•°åŒ–) è¿˜æ˜¯ ${} (æ‹¼æ¥)?
```

#### Step 4: ç¡®è®¤æ±¡ç‚¹ä¼ æ’­é“¾
```
å®Œæ•´è·¯å¾„ç¤ºä¾‹:
[HTTPè¯·æ±‚] â†’ [user.setBio(input)] â†’ [æ•°æ®åº“INSERT] â†’ [æ•°æ®åº“SELECT] â†’ [user.getBio()] â†’ [SQLæ‹¼æ¥] â†’ [executeQuery]

æ£€æµ‹è¦ç‚¹:
- å­˜å‚¨æ—¶æ˜¯å¦å‡€åŒ–? â†’ æ•°æ®åº“ä¸­å­˜å‚¨äº†æ¶æ„æ•°æ®
- å–å‡ºæ—¶æ˜¯å¦å‡€åŒ–? â†’ getBio()è¿”å›åŸå§‹æœªå‡€åŒ–æ•°æ®
- ä¸¤æ®µéƒ½æ— å‡€åŒ– â†’ äºŒæ¬¡æ³¨å…¥æˆç«‹
```

### å¯¹è±¡Getteræº¯æºæ–¹æ³•

#### æ–¹æ³•1: LSPè¿½è¸ªï¼ˆLSP-Enhanced Trackingï¼‰
```
åœºæ™¯: å‘ç° sink è°ƒç”¨äº† user.getBio()

1. LSP goToDefinition(user) â†’ å®šä½userå˜é‡å®šä¹‰
   - å¯èƒ½æ¥è‡ª: userService.findById(), new User()
   
2. å¦‚æœæ¥è‡ªfindById:
   - LSP findReferences(findById) â†’ æ‰¾åˆ°æ‰€æœ‰æŸ¥è¯¢ç‚¹
   - åˆ†ææŸ¥è¯¢è¿”å›çš„å®ä½“å¦‚ä½•è¢«è®¾ç½®
   
3. å¦‚æœæ¥è‡ª new User():
   - è¿½è¸ªå¯¹è±¡çš„ setter è°ƒç”¨
   - æŸ¥æ‰¾å“ªé‡Œè°ƒç”¨äº† setBio()

4. åˆ†æ setter çš„å‚æ•°æ¥æº
   - æ¥è‡ª request.getParameter()?
   - æ¥è‡ªå…¶ä»–æŸ¥è¯¢ç»“æœ?
```

#### æ–¹æ³•2: Grepæ¨¡å¼åŒ¹é…
```bash
# 1. æ‰¾åˆ°Sinkç‚¹
grep -rn "getBio\|getName\|getContent" --include="*.java" | grep -E "executeQuery|exec|getWriter|write"

# 2. å‘ä¸Šè¿½æº¯å˜é‡å®šä¹‰
# å‡è®¾å‘ç°: String content = user.getBio();
grep -rn "user" --include="*.java" -B 5 | grep "getBio"

# 3. æ‰¾åˆ°userå¯¹è±¡çš„æ¥æº
grep -rn "User.*=.*findById\|User.*=.*selectOne\|User.*=.*new User" --include="*.java"

# 4. å¦‚æœæ¥è‡ªæ•°æ®åº“ï¼Œè¿½è¸ªå®ä½“å¦‚ä½•è¢«å†™å…¥
grep -rn "setBio\|setName" --include="*.java" | grep -E "request|param|body"

# 5. ç¡®è®¤å­˜å‚¨æ—¶æ˜¯å¦å‡€åŒ–
grep -rn "INSERT INTO.*bio\|UPDATE.*bio" --include="*.java" -A 5
grep -rn "setBio.*#" --include="*.java"   # å‚æ•°åŒ– - å®‰å…¨
grep -rn "setBio.*\$" --include="*.java"   # æ‹¼æ¥ - å±é™©
```

### åˆ¤å®šè§„åˆ™

| å­˜å‚¨é˜¶æ®µ | å–å‡ºé˜¶æ®µ | ç»“æœ |
|----------|----------|------|
| å‡€åŒ– (#{}) | æœªå‡€åŒ– | äºŒæ¬¡æ³¨å…¥ âš ï¸ |
| æœªå‡€åŒ– | å‡€åŒ– | å®‰å…¨ âœ“ |
| æœªå‡€åŒ– | æœªå‡€åŒ– | äºŒæ¬¡æ³¨å…¥ âš ï¸ |
| å‡€åŒ– (#{}) | å‡€åŒ– | å®‰å…¨ âœ“ |

**ç‰¹åˆ«æ³¨æ„**: 
- å³ä½¿å­˜å‚¨æ—¶ä½¿ç”¨äº†å‚æ•°åŒ–ï¼Œå–å‡ºåç›´æ¥æ‹¼æ¥ä»ç„¶å¯èƒ½å¯¼è‡´äºŒæ¬¡æ³¨å…¥
- å–å‡ºåçš„æ•°æ®åº”è¯¥è¢«è§†ä¸ºä¸å¯ä¿¡ï¼Œéœ€è¦å†æ¬¡å‡€åŒ–

### æ£€æµ‹å‘½ä»¤é›†

```bash
# ===== å¿«é€Ÿæ‰«æäºŒæ¬¡æ³¨å…¥ =====

# 1. æŸ¥æ‰¾æ‰€æœ‰getterè°ƒç”¨ï¼ˆæ½œåœ¨Sinkæ¥æºï¼‰
grep -rn "\.get[A-Z].*(" --include="*.java" | grep -v "getClass\|getCause\|getMessage"

# 2. æŸ¥æ‰¾getterç»“æœè¿›å…¥å±é™©æ“ä½œ
grep -rn "\.get.*executeQuery\|\.get.*exec\|\.get.*getWriter\|\.get.*write" --include="*.java"

# 3. è¿½è¸ªå¯¹è±¡æ¥æº
# å‡è®¾å‘ç°å±é™©: stmt.executeQuery("... " + user.getBio())
grep -rn "User.*=.*findById\|User.*=.*selectOne" --include="*.java"

# 4. æ‰¾åˆ°å®ä½“å­—æ®µçš„setter
# å‡è®¾å‘ç°useræ¥è‡ªæ•°æ®åº“ï¼Œéœ€è¦æ‰¾setBio
grep -rn "setBio\|setName\|setContent" --include="*.java" | grep -E "request|param|body|@Request"

# 5. ç¡®è®¤å­˜å‚¨æ“ä½œçš„å‡€åŒ–æƒ…å†µ
grep -rn "INSERT INTO\|UPDATE.*SET" --include="*.xml" | grep -E "\\\${|#{"
# ${} = å±é™©, #{} = å®‰å…¨

# 6. ç»¼åˆæ£€æµ‹è„šæœ¬
for file in $(grep -rl "executeQuery\|exec\|getWriter" --include="*.java"); do
  echo "=== Checking: $file ==="
  # æŸ¥æ‰¾getterè°ƒç”¨
  grep -n "get[A-Z]" "$file" | head -5
done
```

### æŠ¥å‘Šæ¨¡æ¿

```markdown
## [Critical] äºŒæ¬¡SQLæ³¨å…¥ - UserService.java:45

### åŸºæœ¬ä¿¡æ¯
| å±æ€§ | å€¼ |
|------|-----|
| æ¼æ´ç±»å‹ | äºŒæ¬¡æ³¨å…¥ (Second-Order SQL Injection) |
| ä¸¥é‡ç¨‹åº¦ | Critical |
| CWEç¼–å· | CWE-89 |

### æ”»å‡»é“¾åˆ†æ

```
[Step 1] ç”¨æˆ·è¾“å…¥
  ä½ç½®: ProfileController.java:30
  ä»£ç : user.setBio("admin'--")
  è¯´æ˜: ç”¨æˆ·æäº¤æ¶æ„SQL payload

[Step 2] å­˜å‚¨é˜¶æ®µï¼ˆä¸€æ¬¡ï¼‰
  ä½ç½®: UserMapper.xml:25
  ä»£ç : INSERT INTO user (bio) VALUES (#{bio})
  çŠ¶æ€: âœ“ å‚æ•°åŒ–ï¼Œå®‰å…¨å­˜å‚¨

[Step 3] å–å‡ºé˜¶æ®µï¼ˆäºŒæ¬¡ï¼‰
  ä½ç½®: UserService.java:45  
  ä»£ç : User user = userDao.findById(id)
        String bio = user.getBio();
  è¯´æ˜: æœªå‡€åŒ–ï¼Œç›´æ¥ä½¿ç”¨

[Step 4] å±é™©æ“ä½œ
  ä½ç½®: SearchService.java:60
  ä»£ç : String sql = "SELECT * FROM posts WHERE author='" + bio + "'";
        stmt.executeQuery(sql);
  è¯´æ˜: æ‹¼æ¥åæ‰§è¡Œï¼Œå¯¼è‡´æ³¨å…¥
```

### ä¿®å¤å»ºè®®

```java
// æ–¹æ¡ˆ1: å–å‡ºæ—¶å‡€åŒ–
String bio = user.getBio();
String safeBio = bio.replace("'", "''");  // SQLè½¬ä¹‰
String sql = "SELECT * FROM posts WHERE author='" + safeBio + "'";

// æ–¹æ¡ˆ2: å§‹ç»ˆä½¿ç”¨å‚æ•°åŒ–
String sql = "SELECT * FROM posts WHERE author = ?";
PreparedStatement ps = conn.prepareStatement(sql);
ps.setString(1, user.getBio());

// æ–¹æ¡ˆ3: å­˜å‚¨æ—¶å‡€åŒ–ï¼ˆä½†ä¸æ¨èï¼‰
// å­˜å‚¨æ—¶å‡€åŒ–ä¼šè®©æ•°æ®åº“å­˜å‚¨å·²è½¬ä¹‰æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸
```
