# 代码安全审计完整方法论

> 版本: 2.0.0
> 核心理念: 双轨并行，完整覆盖
> 适用: 所有语言的代码安全审计

---

## 一、完整审计框架

### 1.1 漏洞分类本质

| 漏洞类型 | 本质特征 | 检测方法 | 占比 |
|----------|----------|----------|------|
| **缺失类漏洞** | 应有的控制不存在 | 控制建模法 | ~40% |
| **注入类漏洞** | 用户输入到达危险Sink | 数据流分析法 | ~45% |
| **配置类漏洞** | 不安全的配置 | 配置审计 | ~10% |
| **依赖类漏洞** | 使用有漏洞组件 | SCA扫描 | ~5% |

### 1.2 双轨并行框架

```
                    代码安全审计完整方法论
                            │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  轨道A (50%)    │ │  轨道B (40%)    │ │  补充 (10%)     │
│  控制建模法     │ │  数据流分析法   │ │  配置+依赖审计  │
│                 │ │                 │ │                 │
│ 发现缺失类漏洞  │ │ 发现注入类漏洞  │ │ 发现配置/组件   │
│                 │ │                 │ │ 漏洞            │
│ • 认证缺失      │ │ • SQL注入       │ │                 │
│ • 授权缺失      │ │ • XSS           │ │ • 硬编码凭据    │
│ • IDOR          │ │ • 命令注入      │ │ • 不安全配置    │
│ • 竞态条件      │ │ • 反序列化      │ │ • CVE依赖       │
│ • 重放攻击      │ │ • SSRF          │ │                 │
│ • 业务逻辑      │ │ • 路径遍历      │ │                 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
          │                 │                 │
          └─────────────────┼─────────────────┘
                            │
                            ▼
                ┌─────────────────────┐
                │   完整漏洞覆盖      │
                │   CWE Top 25 100%   │
                └─────────────────────┘
```

### 1.3 两种核心方法的互补关系

| CWE | 漏洞类型 | 控制建模法 | 数据流分析法 |
|-----|----------|------------|--------------|
| 306 | 认证缺失 | ✅ 核心能力 | ❌ |
| 862 | 授权缺失 | ✅ 核心能力 | ❌ |
| 639 | IDOR | ✅ 核心能力 | ❌ |
| 362 | 竞态条件 | ✅ 核心能力 | ❌ |
| 294 | 重放攻击 | ✅ 核心能力 | ❌ |
| 89 | SQL注入 | ❌ | ✅ 核心能力 |
| 79 | XSS | ❌ | ✅ 核心能力 |
| 78 | 命令注入 | ❌ | ✅ 核心能力 |
| 502 | 反序列化 | ❌ | ✅ 核心能力 |
| 918 | SSRF | 部分(白名单缺失) | ✅ 完整覆盖 |
| 22 | 路径遍历 | 部分(校验缺失) | ✅ 完整覆盖 |

**结论**: 两种方法必须并行执行，缺一不可。

---

## 二、轨道A: 控制建模法

### 2.1 核心公式

```
缺失类漏洞 = 敏感操作 - 应有控制

敏感操作存在，但应有的安全控制缺失 = 漏洞
```

### 2.2 三阶段流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ A1. 敏感    │    │ A2. 安全    │    │ A3. 控制    │
│ 操作枚举    │ → │ 控制建模    │ → │ 存在性验证  │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 2.3 A1: 敏感操作分类

| 类别 | 识别特征 | 典型示例 | 风险等级 |
|------|----------|----------|----------|
| **数据修改** | POST/PUT/DELETE | 创建/修改/删除 | 高 |
| **数据访问** | GET + ID参数 | /user/{id} | 中 |
| **批量操作** | export/download/batch | 导出/批量删除 | 高 |
| **权限变更** | role/permission/grant | 角色/权限分配 | 严重 |
| **资金操作** | transfer/pay/refund | 转账/支付/退款 | 严重 |
| **认证操作** | login/password/token | 登录/密码重置 | 严重 |

### 2.4 A2: 安全控制矩阵

| 敏感操作类型 | 必须控制 | 可选控制 |
|--------------|----------|----------|
| **数据修改** | 认证、授权、资源所有权、输入验证 | 审计日志 |
| **数据访问** | 认证、资源所有权/范围限制 | 数据脱敏 |
| **批量操作** | 认证、授权、数量限制 | 频率限制 |
| **权限变更** | 认证、高级授权、权限边界检查 | 审批流程 |
| **资金操作** | 认证、授权、幂等性、并发控制 | 风控检查 |

### 2.5 A3: 缺失控制 → 漏洞映射

| 缺失控制 | 漏洞类型 | CWE |
|----------|----------|-----|
| 认证缺失 | 认证绕过 | CWE-306 |
| 授权缺失 | 功能级授权缺失 | CWE-862 |
| 资源所有权缺失 | IDOR | CWE-639 |
| 授权逻辑错误 | 授权错误 | CWE-863 |
| 幂等性缺失 | 重放攻击 | CWE-294 |
| 并发控制缺失 | 竞态条件 | CWE-362 |

---

## 三、轨道B: 数据流分析法

### 3.1 核心公式

```
注入类漏洞 = Source → [无净化] → Sink

用户可控输入到达危险函数，中途无有效净化 = 漏洞
```

### 3.2 三阶段流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ B1. Source  │    │ B2. Sink    │    │ B3. 污点    │
│ 识别        │ → │ 识别        │ → │ 传播追踪    │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 3.3 B1: Source分类 (用户输入点)

| 类别 | Java | Python | Node.js | PHP |
|------|------|--------|---------|-----|
| HTTP参数 | request.getParameter() | request.args | req.query | $_GET/$_POST |
| HTTP头 | request.getHeader() | request.headers | req.headers | $_SERVER |
| Cookie | request.getCookies() | request.cookies | req.cookies | $_COOKIE |
| 请求体 | @RequestBody | request.json | req.body | php://input |
| 文件上传 | MultipartFile | request.files | req.files | $_FILES |
| 路径参数 | @PathVariable | path params | req.params | URL路由 |

### 3.4 B2: Sink分类 (危险函数)

| Sink类型 | 漏洞 | CWE | 典型函数 |
|----------|------|-----|----------|
| SQL执行 | SQL注入 | 89 | executeQuery, ${}拼接 |
| 命令执行 | 命令注入 | 78 | Runtime.exec, os.system |
| 文件操作 | 路径遍历 | 22 | new File, open() |
| HTTP请求 | SSRF | 918 | HttpClient, requests |
| HTML输出 | XSS | 79 | innerHTML, response.write |
| 反序列化 | RCE | 502 | readObject, pickle.load |
| XML解析 | XXE | 611 | DocumentBuilder.parse |
| 表达式引擎 | 表达式注入 | 917 | SpEL, eval |

### 3.5 B3: 净化措施验证

| Sink类型 | 应有净化 | 验证方法 |
|----------|----------|----------|
| SQL执行 | 参数化查询 | 检查?或#{}占位符 |
| 命令执行 | 命令白名单+参数数组 | 检查是否字符串拼接 |
| 文件操作 | 路径规范化+白名单 | 检查路径校验逻辑 |
| HTTP请求 | URL白名单+内网过滤 | 检查白名单校验 |
| HTML输出 | 编码转义 | 检查转义函数 |
| 反序列化 | 类型白名单 | 检查ObjectInputFilter |
| XML解析 | 禁用外部实体 | 检查setFeature配置 |

---

## 四、补充方法

### 4.1 配置审计

```yaml
检查项:
  - 硬编码凭据 (密码/密钥/Token)
  - 调试模式开启
  - 不安全的CORS配置
  - CSRF保护禁用
  - 敏感端点暴露 (actuator/debug)
  - 不安全的TLS配置
```

### 4.2 依赖审计

```yaml
检查项:
  - 已知CVE漏洞组件
  - 过时依赖版本
  - 不安全的默认配置
工具:
  - Java: OWASP Dependency-Check, Snyk
  - Python: safety, pip-audit
  - Node.js: npm audit, Snyk
  - Go: govulncheck
```

---

## 五、完整审计执行流程

```
┌────────────────────────────────────────────────────────────────┐
│                      开始审计                                   │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│ 0. 技术栈识别                                                   │
│    识别语言、框架、依赖，加载对应语言模块                        │
└────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ 轨道A: 控制建模  │ │ 轨道B: 数据流    │ │ 补充: 配置+依赖  │
│                  │ │                  │ │                  │
│ A1. 敏感操作枚举 │ │ B1. Source识别   │ │ C1. 配置审计     │
│ A2. 安全控制建模 │ │ B2. Sink识别     │ │ C2. 依赖扫描     │
│ A3. 控制存在验证 │ │ B3. 污点追踪     │ │                  │
│                  │ │                  │ │                  │
│ 输出: 缺失类漏洞 │ │ 输出: 注入类漏洞 │ │ 输出: 配置/依赖  │
└──────────────────┘ └──────────────────┘ │ 漏洞             │
          │                   │           └──────────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│ 漏洞汇总 + 风险评估 + 修复建议                                  │
└────────────────────────────────────────────────────────────────┘
```

---

## 六、审计报告结构

```markdown
# 代码安全审计报告

## 一、审计概述
- 审计目标、范围、方法、技术栈

## 二、轨道A: 控制建模审计结果
### 2.1 敏感操作清单
### 2.2 安全控制验证结果
### 2.3 发现的缺失类漏洞

## 三、轨道B: 数据流分析结果
### 3.1 识别的Source/Sink
### 3.2 污点传播路径
### 3.3 发现的注入类漏洞

## 四、补充审计结果
### 4.1 配置安全问题
### 4.2 依赖安全问题

## 五、漏洞汇总
- 按严重程度排序的完整漏洞清单

## 六、修复建议
- 每个漏洞的修复方案
```

---

## 七、快速参考卡片

### 审计时自问清单

```
轨道A - 控制建模:
□ 这是什么类型的敏感操作？
□ 这个操作应该有什么安全控制？
□ 这些控制在代码中存在吗？
□ 如果不存在，就是缺失类漏洞！

轨道B - 数据流分析:
□ 用户输入从哪里进入？(Source)
□ 输入最终到达哪个危险函数？(Sink)
□ 中间有没有有效的净化措施？
□ 如果无净化到达Sink，就是注入类漏洞！
```

### 漏洞覆盖检查

| 漏洞类型 | 用控制建模 | 用数据流分析 |
|----------|------------|--------------|
| 认证/授权/IDOR/竞态 | ✅ | - |
| SQL/XSS/CMD/反序列化 | - | ✅ |
| SSRF/路径遍历 | 部分 | ✅完整 |
| 配置/依赖 | - | 补充方法 |

---

**版本**: 2.0.0
**创建日期**: 2026-02-04
**方法论**: 双轨并行完整覆盖
**适用语言**: 所有
