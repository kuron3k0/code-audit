# Anti-Hallucination Rules Module

> 防幻觉规则模块 - 借鉴自 DeepAudit 的文件验证机制
> 版本: 1.0.0

## 概述

LLM 在代码审计中容易产生"幻觉"，即报告实际不存在的漏洞。本模块定义严格的验证规则，确保每个发现都基于真实的代码分析。

---

## 🔒 核心规则

### 规则 1: 文件存在性验证

```
强制要求: 报告漏洞前必须验证文件存在

✗ 禁止行为:
- 基于"典型项目结构"猜测文件路径
- 假设 config/database.py、app/api.py 等文件存在
- 使用未经验证的文件路径

✓ 正确做法:
- 使用 Glob 工具发现文件
- 使用 Read 工具确认文件内容
- 只报告实际读取过的文件中的漏洞
```

**验证流程**:
```
1. Glob: 发现项目中的文件
2. Read: 读取目标文件内容
3. 分析: 在实际代码中识别漏洞
4. 报告: 使用真实的文件路径和行号
```

### 规则 2: 代码真实性验证

```
强制要求: code_snippet 必须来自实际读取

✗ 禁止行为:
- 凭记忆编造代码片段
- 使用知识库中的示例代码作为项目代码
- 推测代码可能的写法

✓ 正确做法:
- 直接复制 Read 工具返回的代码
- 保持代码格式和缩进
- 包含足够的上下文
```

### 规则 3: 行号准确性验证

```
强制要求: 行号必须在文件实际行数范围内

✗ 禁止行为:
- 编造行号
- 使用估计的行号
- 报告超出文件行数的行号

✓ 正确做法:
- 使用 Read 工具返回的行号
- 如果不确定，重新读取文件确认
```

### 规则 4: 技术栈一致性验证

```
强制要求: 发现必须与项目技术栈一致

✗ 禁止行为:
- 在 Rust 项目中报告 Python 漏洞
- 在纯前端项目中报告数据库漏洞
- 假设项目使用某种框架

✓ 正确做法:
- 先识别项目技术栈
- 只报告与技术栈相关的漏洞
- 不确定时明确标注
```

### 规则 5: 知识库隔离

```
强制要求: 知识库示例 ≠ 项目代码

✗ 幻觉来源:
1. 查询 auth_bypass 知识 → 看到 JWT 示例
2. 没有在项目中找到 JWT 代码
3. 仍然报告 "JWT 认证绕过漏洞"

✓ 正确做法:
1. 知识库用于理解漏洞概念和检测方法
2. 必须在实际代码中找到对应模式
3. 只报告实际看到的漏洞
```

---

## 验证清单

在报告每个漏洞前，检查以下清单:

```
□ 文件路径是通过 Glob/Read 工具确认存在的
□ 代码片段是从 Read 工具输出中复制的
□ 行号在文件实际行数范围内
□ 漏洞类型与项目技术栈一致
□ 不是从知识库示例推测的
```

---

## 违规后果

| 违规类型 | 后果 |
|----------|------|
| 文件不存在 | 发现无效，不计入报告 |
| 代码编造 | 发现无效，不计入报告 |
| 行号错误 | 降级为 [需验证] |
| 技术栈不匹配 | 发现无效，不计入报告 |

---

## 常见幻觉模式

### 模式 1: 典型项目结构假设

```
幻觉: "Python 项目通常有 config.py，可能存在硬编码密钥"
现实: 项目可能没有 config.py，或密钥管理方式不同

正确: 使用 Glob **/*.py 发现实际文件，然后检查
```

### 模式 2: 框架默认行为假设

```
幻觉: "Django 项目的 settings.py 可能有 DEBUG=True"
现实: 项目可能使用环境变量或不同的配置方式

正确: 读取实际的 settings.py 文件内容
```

### 模式 3: 知识库污染

```
幻觉: "根据 SQL 注入知识，项目的 User.query() 可能有漏洞"
现实: 项目可能使用 ORM 参数化查询，完全安全

正确: 读取实际的数据库查询代码，分析是否真的有注入点
```

### 模式 4: 版本号推测

```
幻觉: "Spring Boot 项目可能使用旧版本，存在 CVE"
现实: 需要检查实际的 pom.xml 或 build.gradle

正确: 读取依赖配置文件，确认实际版本号
```

---

## 最佳实践

### 1. 先验证，后报告

```
错误流程: 分析 → 报告 → (可能发现文件不存在)
正确流程: 发现文件 → 读取文件 → 分析 → 验证 → 报告
```

### 2. 保持怀疑态度

```
对每个发现问自己:
- 我真的读取过这个文件吗?
- 代码片段是我实际看到的吗?
- 行号是准确的吗?
```

### 3. 宁缺毋滥

```
核心原则: 宁可漏报，不可误报

误报的危害:
- 浪费开发者时间
- 降低审计报告可信度
- 可能导致真正的漏洞被忽视
```

---

## 与其他模块的关系

| 模块 | 关系 |
|------|------|
| taint_analysis.md | 污点分析必须基于真实代码路径 |
| false_positive_filter.md | 防幻觉是防误报的前置步骤 |
| comprehensive_audit_methodology.md | 系统性审计包含文件验证 |
